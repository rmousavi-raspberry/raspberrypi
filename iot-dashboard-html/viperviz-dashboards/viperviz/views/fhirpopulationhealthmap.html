<!DOCTYPE html>
<html lang="en">
<!--
===========================================
Developed by: Sebastian Maurice, PhD
Copyright 2021 OTICS Advanced Analytics.
All rights reserved.
For help email: support@otics.ca
Website: http://www.otics.ca
=========================================-->
<head>
    <meta charset="UTF-8" />
	   <link rel="shortcut icon" type="image/x-icon" href="./oticsico.png" />
    <title>FHIR Global Population Disease Surveillance Dashboard</title>
    <style>
	.loader {
  border: 7px solid #f3f3f3;
  border-radius: 50%;
  border-top: 7px solid blue;
  border-bottom: 7px solid blue;
  width: 70px;
  height: 70px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
	
h1 { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 24px; font-style: normal; font-variant: normal; font-weight: 700; line-height: 26.4px; } h3 { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 12px; font-style: normal; font-variant: normal; font-weight: 100; line-height: 10.4px; } h4 { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 1px; font-style: bold; font-variant: normal; font-weight: 400; line-height: .4px; } p { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 14px; font-style: normal; font-variant: normal; font-weight: 400; line-height: 20px; } blockquote { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 21px; font-style: normal; font-variant: normal; font-weight: 400; line-height: 30px; } pre { font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, AppleGothic, sans-serif; font-size: 13px; font-style: normal; font-variant: normal; font-weight: 400; line-height: 18.5714px; }

.a {
    background: linear-gradient(to bottom, #33ccff 0%, #ff99cc 100%);
}
.b {
         background: linear-gradient(to top left, #ffffff 0%, #ccffff 100%);


}
 
      #gauge_avgrisk {
        width:400px; height:320px;
		
      }
        #gauge_currrisk {
        width:200px; height:120px;
        display: inline-block;
        margin: 1em;
      }

        #chart_div {
              float: left;
        }

        
        body {
            
            justify-content: center;
            align-items: center;
        }
.orange-background {
   background-color: orange;
  }

 .orchid-background {
  background-color: orchid;
 }

.beige-background {
 background-color: beige;
  }		
 .columnTitle {
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
          font-size: 14px; 
          color:white;
          background-color: #607A75
      } 
.grid {
  display: grid;
  grid-gap: var(--card-padding);
  margin: 0 auto;
  max-width: 60em;
  padding: 0;
 
  @media (min-width: 42em) {
    grid-template-columns: repeat(3, 1fr);
  }
}
th, td {
  padding: 6px;
}

.card {
  background-color: #fff;
  border-radius: var(--card-radius);
  position: relative;
  
  &:hover {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.15);
  }
}

.plan-type {
  color: var(--color-green);
  font-size: 1.5rem;
  font-weight: bold;
  line-height: 1em;
}
 .btnsave{
       width: 50px;
	   height: 25px;
	   background: linear-gradient(to bottom right, #609931, #87bc27);
	   color: white;
	   align: top;
    }
	
.padding
{
padding: 5px 6px 3px 3px;
}	  
    </style>
<script type="text/javascript" src="/js/attention.js"></script>   

<script type="text/javascript" src="/js/r.min.js"></script>   

<script type="text/javascript" src="/js/justgage.js"></script>   
<script type="text/javascript" src="/js/justgage.min.js"></script>   

<script>

function image(thetype,mess) {
        
		var titletext="";
		var helptext="";
		
		if (thetype=="gauge"){
		   titletext="Health Risk Meter";
		    helptext="The Health Risk Meter shows the average health risk percentage of the population across time windows. The percentage is computed by taking a ratio of the number of out of bounds symptoms in the population divided by the total population.  For example, if the current sliding window contains 100 population records, each with 10 symptoms being monitored, and 20 people are out of bounds for atleast 40% of the symptoms, then the risk is 20/100 or 20%.  The current risk is for the sample of people that exceed any of the symptom' bounds."; 
		}else if (thetype=="barchart"){
           titletext="Health Symptom Monitoring Bar Chart";
		    helptext="The Symptom Monitoring Bar Chart shows the count of Total Symptom records in the data stream (GREY Bar), against the symptoms that are above the upper bound (BLUE Bar)."; 
		
		}else if (thetype=="intensity"){
           titletext="Symptom Intensity Curve With Annotations";
		    helptext="The Symptom Intensity Curve With Annotations shows the intensity of the symptoms' values. The Intensity curve is computed by first determining which symptoms are out of bound (or higher than normal), if symptoms are higher than normal, then a delta value is computed by subtracting the computed value from the mean value of the symptom.  The absolute values of the deltas are then summed up and plotted on the intensity curve.  For example, if monitoring body temperature (BT) and heart rate (HR), and the computed value of BT=100, and HR=120, and the upper bound for BT is 98, and upper bound for HR is 80, both BT and HR are out of bounds.  If the mean value of BT is 97, and mean value for HR is 70, then ONE point on the intensity curve is the absolute value of: |100-97| + |120-70| = 53.  The unit of measurements is similar to a basis point to see how much this value differs from 0.  The larger this value differs from 0, the more intense the symptoms in the population and higher the health risk for a particular Disease emerging.  Each point on the intensity curve has its own ANNOTATION with all the details associated with the point."; 
		
		}else if (thetype=="table"){
		  titletext="Table Data";
		    helptext="The data in the table takes the MAX and (AVG)ERAGE for ALL patients for EACH Symptom in a data stream.  For example, if a data stream for a given time sliding window of 60 seconds, contains 20 patients with body temperature and systolic, VIPER will take the MAX and AVG for ALL 20 patients for body temperature and systolic.  The MAX or AVG values are record in the 'Current Population Value' column.  The NORMAL MEAN and NORMAL UPPERBOUND values are specified by a human for that symptom.  Total messages are the number of message VIPER processed to compute the MAX and AVG values.  KAFKAKEY is a unique hash key for the Kafka message.   OFFSET/PARTITION show the actual location of the PROCESSED message in Kafka.  By PROCESSED we mean the MAX and AVG value process.  Time Window Start and End are the start and end of the Time Sliding Window in the data stream that is processed to compute MAX and AVG for 20 patients.  Date/Time is when this processing took place by VIPER.  SYMPTOM/SYMPTOMCODE are the FHIR standard symptom and codes.  PROCESS TYPE is the type of processing done by VIPER: AVG or MAX."; 
		
		}else if (thetype=="healthrisk"){
		  titletext="Real-Time Health Risk";
		    helptext="The health Risk graph plots the real-time Health Rish percentage over time to show how the Health risk is trending."; 
		
		}
		
		
		
          new Attention.Prompt({
                    title: titletext,
                    content: helptext,
                });
			}
</script>	
</head>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">


<link href="/css/tilesdisease.css" rel="stylesheet">
<link href="/css/attention.css" rel="stylesheet">
<link href="/css/button.css" rel="stylesheet">
<link href="/css/textbox.css" rel="stylesheet">
<link href="/css/table3d.css" rel="stylesheet">
<link href="/css/dropdown.css" rel="stylesheet">
<link rel="stylesheet" href="/leaflet/leaflet.css" />
<link href="/css/component-custom-switch.css" rel="stylesheet">

<style>

 #map {
        position: relative;
        width: 100%;
        height: 570px;
      }
</style>
<body>
<center><a href='https://www.smilecdr.com/' target="_blank"><img src='./smilelogo.png' height=60></a> | <a href='http://www.otics.ca/' target="_blank"><img src='./OTICS-New-Logo-Black.png' width=150 height=60></a></center>

<table style="width: 99%;height: 80px;    background: linear-gradient(135deg,  rgba(102, 255, 217,1) 0%,rgba(191, 255, 0,1) 50%,rgba(191, 255, 0,1) 51%,rgba(102, 255, 217,1) 100%);">

<tr>
<td>
<div class="row justify-content-md-center">
	
    <div class="col-12" style="padding-top: 1px">
        <center><label id="maintitle"><h1><b><i>Real-Time Global Population Disease Surveillance Dashboard</b> Using FHIR/KAFKA/TML</i></h1></label></center>
    </div>
</div>

<div class="row justify-content-md-center">
    <div class="col-12">

        <div id="selectSymbol">
            <form id="idForm">
		<h6>
			 <b> Last Kafka Access Time:</b></b> <label id="accesstime"></label><br>
			 <b> Kafka Cluster:</b> <label id="kafkacluster"></label><br>			
			<b>Health Issues Found In Following Areas:</b><label id="issues"></label><br>	
			</h6>
		 				<div class="loader" id="loaderdiv" style="display:none;float: left"></div>

				<button id="start" class="btn btn1" name="submit" >Start Streaming</button>
				<label id="statustext"></label>
	<div style="float: right;display:block;" class="custom-switch custom-switch-label-io">
  <input class="custom-switch-input" id="example_1" type="checkbox" onchange="toggleDiv();">
  <label class="custom-switch-btn" for="example_1"></label>
</div>	
				
				
				</td>
				</tr>
			</table>				
				
			
		
		<table border=0 style='width: 1300px;height: 400px; vertical-align: top;'>
				<tr>		
				
				<td style="text-align: left; vertical-align: top;">
				<table valign='top'  id="symptomtable" style="width: 400px; height: 100%;display:none">
				<tr>
				<td valign='top' >
			   <div class="tile wide quote">
               <div class="header">
               <div id="totsymptoms" class="count">0</div>
               <div class="title">Population Symptoms Being Processed</div>
               </div>
                </div>
			   <br>
    			<img src='./help.png' width=30 height=27  class="padding"  onclick="image('barchart','')">	
				<center> <div id="downloadpatientdataurl"></div></center>
				 <div id="barchart_div" style="position:relative; text-align: left; vertical-align: middle;width:370px;height: 335px" ></div>				 

			 <div id="barchartlabel_div" style="text-align: left; vertical-align: top;width:100%;height: 280px;overflow-y:auto;" ></div>	
<!--               <table >				
				 <tr>
				 <td>
				 	<img src='./help.png' width=30 height=27  style="float: top;" onclick="image('barchart','')">	
				 <div id="barchart_div" style="text-align: left; vertical-align: middle;width:300px;height: 450px" ></div>				 
				 </td>
				 <td>
		        <div id="barchartlabel_div" style="text-align: left; vertical-align: left;width:100px;overflow-y:scroll;" ></div>				 
				 
				 </td>
				 </table>
	-->			 
				
		       </td>
			   </tr>
			   </table>
			   </td>
			   
			   
			   
				<td  valign='top' >				
				<table valign='top' style="width: 300px; height: 100%">
				<tr>
				<td valign='top'>
				 <center>
			<div class="tile wide resource">
    <div class="header">
      <div id="avgrisk" class="count">TBD</div>
      <div class="title">Avg. Population Health Risk</div>
    </div>
  </div>
				 
<img src='./help.png' width=30 height=27  class="padding" style="float: left;" onclick="image('gauge','')">				

				  <div id="gauge_avgrisk"></div><br><br><br><br><br>
						 <label id="currentrisk"><font size=2><b>Current Health Risk</b></font></label><br>
				  <div id="gauge_currrisk"></div>
				  
				
                   </center>				 
				 <div id="gaugehealthrisk2_div" ></div>				 				 
				</td>
			   </tr>
			   </table>
			   </td>
				<td  >	
				<table>
				<tr>
				<td>
				<table border=0 id="maptable" style='width: 1800px;height: 100%; vertical-align: top;'>
				

				<tr>				
				<center>
			<div class="tile job">
    <div class="header">
      <div id="totrecs" class="count">0</div>
      <div class="title">Total Kafka Messages Processed</div>
    </div>
  </div>
			<div class="tile wide job">
    <div class="header">
      <div id="totissues" class="count">0</div>
      <div class="title">Health Issues Found</div>
    </div>
  </div>
			<div class="tile wide job">
    <div class="header">
      <div id="tottime"  class="counttimewindow"></div>
      <div class="title">Kafka Time Window Analysed</div>
    </div>
  </div>
    </center>
				<td  valign='top'>	
				<!-- <div id="chart_div" style='width: 1250px; height: 170px;vertical-align: top;'></div>	-->
			
				<center><h4>Real-Time Health Risk Map and Timeline (Patients Exceeding Symptom Bounds)</h4></center>
                 <div id="map"></div>
				 
				 <script type="text/javascript" src="/leaflet/leaflet.js"></script>   
				         <script src="/leaflet/leaflet-div-heatmap.js"></script>

				 
                  <script>
					const map = L.map('map', {
					center: [33.916386, -80.899591],
					zoom: 10.38
					});
					
					setInterval(function () {
                      map.invalidateSize(true);
                   }, 10);


					L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map); 

	              var heatmap = new L.DivHeatmapLayer();
              
                 heatmap.addTo(map);

				  </script>
								
				 </td>
				
				</tr>
				 <tr>
				
				<td valign='top'>	
				
	
				<center>

<div class="selectdiv" id="dropdowns" style="display:none"> 
  <label>Save Risk Data For:&nbsp; 
        <select id="riskhours" valign="center" onchange="getSavehours(this.value,'hours');">
          <option selected> Select Hours </option>
          <option value=1>1 hour</option>
          <option value=2>2 hours</option>
          <option value=3>3 hours</option>
          <option value=4>4 hours</option>
          <option value=5>5 hours</option>
          <option value=6>6 hours</option>
          <option value=7>7 hours</option>
          <option value=8>8 hours</option>
          <option value=9>9 hours</option>
          <option value=10>10 hours</option>
          <option value=11>11 hours</option>
          <option value=12>12 hours</option>
          <option value=13>13 hours</option>
          <option value=14>14 hours</option>
          <option value=15>15 hours</option>
          <option value=16>16 hours</option>
          <option value=17>17 hours</option>
          <option value=18>18 hours</option>
          <option value=19>19 hours</option>
          <option value=20>20 hours</option>
          <option value=21>21 hours</option>
          <option value=22>22 hours</option>
          <option value=23>23 hours</option>
          <option value=24>24 hours</option>
		  
      </select> 
  </label>&nbsp;&nbsp;<label> When Avg. Risk >&nbsp;&nbsp;
  <select id="riskperc" valign="left"  onchange="getSavehours(this.value,'perc');">
          <option selected> Select Hours </option>
          <option value=5>5%</option>
          <option value=10>10%</option>
          <option value=15>15%</option>
          <option value=20>20%</option>
          <option value=25>25%</option>
          <option value=30>30%</option>
          <option value=35>35%</option>
          <option value=40>40%</option>
          <option value=45>45%</option>
          <option value=50>50%</option>
          <option value=55>55%</option>
          <option value=60>60%</option>
          <option value=65>65%</option>
          <option value=70>70%</option>
          <option value=75>75%</option>
          <option value=80>80%</option>
          <option value=85>85%</option>
          <option value=90>90%</option>
          <option value=95>95%</option>
		  
      </select> </label><label >&nbsp;&nbsp;<input type="input" class="form__field" width=100 placeholder="Then Enter Emails to Send Patient Data File (Separate with Comma)" name="Email" id='riskemails'  /> | <input type="input" class="form__field" width=100 placeholder="Enter Kafka Topic To Save Results" name="Kafka" id='kafkatopic'  /><input type='button' id="emailsave" class="btnsave" value="Save" name="Save" onclick="saveEmails(riskemails.value);">&nbsp;&nbsp;<input type='checkbox' id='backcheck' onchange="saveCheckbox(this,'background');"> Background
</label>
 <div id="riskchart_div" style="position:relative;text-align: top; vertical-align: top;width:100%;height: 390px;margin-top:-18px;display:none"></div>				 
				
</div>
			</center>				
				  
				 </td>
				 
				 
				 </tr>  
				 </table>
				 </td>
				 </tr>
				 </table>
				 </td>
				 
                 </tr>
				 <tr>				 
				 <td colspan=3>
				 <table style="width: 100%;">
                 
				 
				 <tr>
				 <td>
				 <img src='./help.png' width=30 height=27 class="padding" style="float: top;" onclick="image('table','')">	
				 <center><a id="Export" href="#"> Download as CSV </a> </center>
 				  <div id="table_div"></div>
				  </td>
				  </tr>
				  </table>
                 </td>
				 
				 </tr>
                 </table>				 
				 <!--  <textarea name="txtData" id="txtData" style="display: none;" class="textboxmulti"></textarea> -->
            </form>
        </div>
        <div id="display"></div>
    </div>
	
	<i><b>Powered by:</b> Transactional Machine Learning, Kafka, Viper, Viperviz<br><b>Developed by:</b> OTICS Advanced Analytics, Inc.</i>
	<br><b>Enter Dashboard Password:</b> <input type=password id="dashpass"><br><br>


 <textarea  id="patientdata" name="patientdata" hidden></textarea>


</div>

    <!-- CONTAINER FOR CHART -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="/js/plotly-2.14.0.min.js"></script>
<script type="text/javascript" src="/js/d3.min.js"></script>

    <script>

        // load current chart package
        google.charts.load("current", {
            packages: ["corechart", "line"]
        });

        google.charts.setOnLoadCallback(drawChart);
		google.charts.load('current', {'packages':['table','annotatedtimeline','gauge','bar']});

		google.charts.setOnLoadCallback(drawTable2);
  
		google.charts.setOnLoadCallback(drawJustgage);
	       google.charts.setOnLoadCallback(drawDiffChart);

	  
		
     ////////// Load save hours

//var x = document.getElementById("riskemails");
//x.addEventListener("focus", saveEmails, true);


 // console.log(localStorage.key(0));
        var START=0;
	  var ws;
	  var topic="";
	  var offset=-1;
	  var groupid="";
	  var append=0;
	  var rollbackoffset=0;
	  var topictype="";
	  var vipertoken="";
	  var consumerid="";
	  var secure=0;
	  var mainport="";
	  var websocketport="";
	  //////////////////////////
	 // var data;
	  var datatbl;
	 // var datatbl2;
	   var maintable;
	//  var chart=null;
	  var dataintable=[];
	//   var dataintable2=[];
	  //var datainchart=[];
	  var kafkakeyarr=[];
	  var totalpredictions=0;
	  var predictioncount=0;
	 // var jsonhist="";
	  var kafkacluster="";
	  var issues="";
	  var issuecount=0;                     
	  var idkeyarr;
	  var maingaugepercentage=0;
	   var maingaugepercentageavg=0;
	   var kafkatopictowrite="";
	   
	  var timestart="";
	  var timeend="";
	   var icvals = [];
	   var mainmonitoring="";
	   var healthriskarray= [];
	   var maintimestamp="";
	   var riskdatanum=0;
	   var patientdatanum=0;
	   var patientdatanumcurrent;
	   var totalriskdata=150;
	    var totalriskdatatosave=3000; // 3000 = ~4h of data 
	//   var riskdatatosave = [];
	//   var riskdataarray;
	//   var oldData;
	  // var newData;
	   var symptommap;
	   var identifiermap;
	//   var superidentifiermap;
	   var riskthreshold=70;
	   var mainpatientbuf="";
	   var mainemails="";
	   var symptomcount=0;
	   var chartrisk=null;
	   var barChartDiff=null;
	   var backcheck=false;
       var chartguage=null;
	   var chartguagesm=null;
       var foundissues=[];  // these are the preprocessed values 
       var previouspatientdatasaved = [];
	   var mainriskhourstosave=0;
	   var dobackground=0;
	   var mainkafkatopic="";
	   var maintotalmessages=0;
	   var uniquepatients=0;
	   var mainfoundrisk=0;
	   
		getSavehours(-1,"hours");
		getSavehours(-1,"perc");
		getSavehours(-1,"emails");
		getSavehours(-1,"backcheck");
	   getSavehours(-1,"filenumber");
	   getSavehours(-1,"kafkatopic");
	   
	         // create options object with titles, colors, etc.
	var cssClassNames = {
		'headerRow': 'columnTitle',
		'tableRow': '',
		'oddTableRow': 'beige-background',
		'selectedTableRow': 'orange-background large-font',
		'hoverTableRow': '',
		'headerCell': 'gold-border',
		'tableCell': '',
		'rowNumberCell': 'underline-blue-font'};
     		 
      var options = {
           title: "Health Monitoring Values For " + topic,
            hAxis: {
                title: "Interval",
				format: '0'
             },
            vAxis: {
                 title: "Value"
				 
             },
			 tooltip: {
				isHtml: true
			},
			 explorer: {
				actions: ['dragToZoom', 'rightClickToReset'],
				axis: 'horizontal',
				keepInBounds: true
				},
			 displayAnnotations: true,
			 displayRangeSelector: false, 
			 allowHtml: true,
			 scaleType:'maximized',
			 thickness: 3,
		   chartArea:{top:10,width:"100%",height:"100"}
        };

      var g1 = new JustGage({
          id: "gauge_avgrisk",
          value: 0,
          min: 0,
          max: 100,       
          label: "Avg. Health Risk"
        });

      var g2 = new JustGage({
          id: "gauge_currrisk",
          value: 0,
          min: 0,
          max: 100,
          label: "Current Health Risk"
		 
        });
      
	  function circleWithText(latLng, txt, circleOptions,popupmess) {
	/*	var icon = L.divIcon({
		html: '<div class="txt">' + txt + '</div>',
		className: 'circle-with-txt',
		iconSize: [40, 40]
		});*/
		var circle = L.circleMarker(latLng, circleOptions);
		var marker = L.marker(latLng, {
		
		});
		    
		var group = L.layerGroup([circle, marker]);
		return(group);
	}

    function toggleDiv(){

    var status = document.getElementById("symptomtable").style.display;
	
	//toggleDiv('machinelearning');toggleDiv('xenese')
      //document.getElementById(divid).style.display="none";
	

    if (status == 'block' || status=='') {
      document.getElementById("symptomtable").style.display="none";

      document.getElementById("dropdowns").style.display="none";
	   document.getElementById("riskchart_div").style.display="none";
	 
	  document.getElementById("maptable").style.width="1800px";

	  document.getElementById("map").style.height="570px";
	  
     } else {
      document.getElementById("symptomtable").style.display="block";
      document.getElementById("symptomtable").style.width="400px";
	  
	    document.getElementById("dropdowns").style.display="block";
	   document.getElementById("riskchart_div").style.display="block";

	  document.getElementById("maptable").style.width="1400px";
	   document.getElementById("maptable").style.height="300px";
	   
	  document.getElementById("map").style.width="100%";
	   document.getElementById("map").style.height="300px";
	  
     }


	 map.invalidateSize(true);

   }


  function promptDownload(content, fileName) {
      
	  content = content.replaceAll(";","\n");
	  
      var a = document.createElement('a');
      a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(content);
      a.download = fileName;
       a.style.display = "none";
       document.body.appendChild(a);
       a.click();
      document.body.removeChild(a);
   }

   /* var btn = document.querySelector("button"),
    txtArea = document.querySelector("textarea");
    btn.addEventListener("click", function(e){
     promptDownload(txtArea.value, "Test.csv");
   });*/

    function getZi(totrecs){
	   var color1;
	   var color2;
	   const green="#59c918";
	   const green2="#45855a";
	   
	   const yellow="#f7be02";
	   const yellow2="#6e683a";

	   const red="#c93441";
	   const red2="#ff1b6b";
	   
              if (totrecs > 100){                  			   
                    zi = 150;
					color1=red;
					color2=red2;
					
				  }else if (totrecs > 30 && totrecs <= 100){
                   zi = 135;
					color1=red;
					color2=red2;
				   
                   }else if (totrecs >25 && totrecs <=30){
                   zi = 96;
					color1=yellow;
					color2=yellow2;
				   
                   }else if (totrecs >20 && totrecs <=25){
                   zi = 80;
					color1=yellow;
					color2=yellow2;
				   
                   }else if (totrecs >15 && totrecs <=20){
                   zi = 78;
					color1=yellow;
					color2=yellow2;
				   
                   }else if (totrecs >10 && totrecs <=15){
                   zi = 67;
					color1=yellow;
					color2=yellow2;
				   
                   }else if (totrecs >5 && totrecs <=10){
                   zi = 45;
					color1=green;
					color2=green2;
				   
                   }else if (totrecs >0 && totrecs <=5){
                   zi = 32;
					color1=green;
					color2=green2;
				   
                   }				  
    	
		return [zi,color1,color2];
	}
	
	function getZisym(symptom,value){
	   var color1;
	   var color2;
	   const green="#59c918";
	   const green2="#45855a";
	   
	   const yellow="#f7be02";
	   const yellow2="#6e683a";

	   const red="#c93441";
	   const red2="#ff1b6b";
	   
/*	        identifier = "8310-5_preprocessed_Max 100.4 98.6 Body-Temperature-F,8331-1_preprocessed_Avg 38 37 Body-Temperature-C,\
8480-6_preprocessed_Avg 130 115 Systolic-Blood-Pressure,8462-4_preprocessed_Avg 90 78 Diastolic-Blood-Pressure,\
38208-5_preprocessed_Avg 7 4 Pain-severity-Reported,72514-3_preprocessed_Avg 7 4 Pain-severity-0-10-verbal-numeric-rating-[Score],\
8867-4_preprocessed_Avg 120 80 Heart-rate"*/

      //console.log(symptom, value);
	  
	   if (symptom=="8310-5"){
	     if (value > 100 && value <= 110){
		   zi = 38;
			color1=yellow;
			color2=yellow2;		    
		 }else if (value > 110){
		   zi = 65;
			color1=red;
			color2=red2;		 
		  }
	   }else if (symptom=="8331-1"){
	     if (value > 36 && value <= 38){
		   zi = 38;
			color1=yellow;
			color2=yellow2;		    
		 }else if (value > 38){
		   zi = 45;
			color1=red;
			color2=red2;		 
		  }	   	      
	   }else if (symptom=="8480-6"){
	     if (value > 110 && value <= 120){
		   zi = 38;
			color1=green;
			color2=yellow2;		    
		 }else if (value > 120 && value < 135){
		   zi = 55;
			color1=yellow;
			color2=red2;		 
		  }else if (value > 135){
		   zi = 75;
			color1=red;
			color2=red2;		 
		  }	   	      
        
	  }else if (symptom=="8462-4"){
	     if (value > 78 && value <= 90){
		   zi = 38;
			color1=green;
			color2=yellow2;		    
		 }else if (value > 90 && value < 100){
		   zi = 55;
			color1=yellow;
			color2=red2;		 
		  }else if (value > 100){
		   zi = 75;
			color1=red;
			color2=red2;		 
		  }	   	              
	  }else if (symptom=="8867-4"){
	     if (value > 70 && value <= 90){
		   zi = 38;
			color1=green;
			color2=yellow2;		    
		 }else if (value > 90 && value <= 100){
		   zi = 55;
			color1=yellow;
			color2=red2;		 
		  }else if (value > 100){
		   zi = 75;
			color1=red;
			color2=red2;		 
		  }	   	              
	  }else if (symptom=="38208-5"){
	     if (value > 4 && value <= 6){
		   zi = 48;
			color1=yellow;
			color2=yellow2;		    
		 }else if (value > 6){
		   zi = 65;
			color1=yellow;
			color2=red2;		 
		  }	   	              
	  }else if (symptom=="72514-3"){
	     if (value > 4 && value <= 6){
		   zi = 48;
			color1=yellow;
			color2=yellow2;		    
		 }else if (value > 6){
		   zi = 65;
			color1=yellow;
			color2=red2;		 
		  }	   	              
	  }				   
	   
	   
		return [zi,color1,color2];
	}
	
   function addHeatdata(maindetailmap){
   		heatmap.clearData();
		
		var heatdata = [];						  
		var vlen;
        var keybuf;
		var sns;	
		var risk;
		var buf;
		var pid;
		var valbufnum;
        var val1;
	    var lat;
    	var lon;		
		var pmess;
		var tr;
		var latlonbuf="";
		
		var latlonmap = new Map();
		
      //console.log(superidentifiermap);
	  	//for (const [key, value] of superidentifiermap) {
		
		//console.log("maindetailmap=",maindetailmap);		
		
		for (const [key, value] of maindetailmap) {
		
				 risk = maingaugepercentageavg;

		//console.log("key=",key, " value=",value);		
				
				for (i in value) {
//	              console.log(key2,value2);
				    vlen = value.length;
                   keybuf=`${key}`;
				    sns=getSymptomname(keybuf);	
		
		      
				//  for (i in value2){ // array
				     buf = value[i];
		   		     pid = buf.substring(0, buf.lastIndexOf("("));
				//	 console.log("pid====",pid);
					 
					 valbufnum= buf.substring(
                     buf.indexOf("(") + 1, 
                     buf.lastIndexOf(")")                
				      );
                    
         			 val1 = valbufnum.split(",")[0];
         			 loc = valbufnum.split(",")[4];
         			 gender = valbufnum.split(",")[5];

					 lat = valbufnum.split(",")[1];
					 lon = valbufnum.split(",")[2];
                     if (lat!="n/a" && lon !="n/a"){
					   latlonbuf=risk + "=" + lat + "=" + lon + "=" + val1 + "=" + sns[0];
					   //console.log("latlonbuf=",latlonbuf, " valbufnum=",valbufnum, " sns=",sns);
					 					
					   var retbuf = latlonmap.get(latlonbuf);
					   if (pid!=""){
						 if(retbuf){
						  retbuf = retbuf +  pid + "," + risk + "," + sns[1] + " ("+ sns[0] + ")," + val1 + "," + lat + "," + lon + "," + loc + "," + gender + "," + sns[0] + ";";
						 }else{
						  retbuf = pid + "," + risk + "," + sns[1] + " ("+ sns[0] + ")," + val1 + "," + lat + "," + lon + "," + loc + "," + gender + "," + sns[0] + ";";
						 }
					   
					     //console.log("latlonbuf=",latlonbuf, "retbuf=",retbuf);
						 latlonmap.set(latlonbuf, retbuf);
						 }
				   }
				   //console.log("latlonbuf=",latlonbuf," retbuf--------",retbuf);
				   
				//} 
			}
		}	
				   
       //console.log("latlonmap===========",latlonmap);
/*
pmess= <b>RiskLevel:</b> 45.5<ul><li><b>PatientID:</b> Patient/0bbd4d6c-44fc-e27a-5ade-1ce39097b630</li><li><b>Symptom:</b> Pain-severity-Reported</li><li><b>Value:</b> 8.4076</li><li><b>Latitude:</b> 43.075968</li><li><b>Longitude:</b> -107.290284
fhirpopulationhealthmap.html?topic=fhir-health-monitor&offset=-1&groupid=&rollbackoffset=70&topictype=prediction&append=0&secure=1:641 pmess= <b>RiskLevel:</b> 45.5<ul><li><b>PatientID:</b> Patient/0bbd4d6c-44fc-e27a-5ade-1ce39097b630</li><li><b>Symptom:</b> Pain-severity-Reported</li><li><b>Value:</b> 8.8039</li><li><b>Latitude:</b> 43.075968</li><li><b>Longitude:</b> -107.290284
*/
               var mainlat;
			   var mainlon;			
               var varr = [];			   
			   var totrecs = 0;
			   var mainrisk;
			   var det;
               var zi;
			   var a;
			   uniquepatients=0;
			   
               for (const [keym, valuem] of latlonmap) {
			        mainrisk = keym.split("=")[0];
					mainlat = keym.split("=")[1];
			        mainlon = keym.split("=")[2];
					
					mainvalue = keym.split("=")[3];
					symptom = keym.split("=")[4];
					
				    varr = valuem.split(";");
                   pmess="";
				   totrecs=0;
				   
				   pmess = "<b><font color='red'>Avg. RiskLevel:</font> " + mainrisk + "</b><br>";
				   
                   for (i in varr){
					 det = varr[i].split(",");
					 if (det[0]!=""){
 				       totrecs = totrecs + 1;
                       pmess += "<font size=4>" + totrecs + ". <b>PatientID:</b> " + det[0] + "<ul><li><b>Symptom:</b> " + det[2] + "</li><li><b>Value:</b> " + det[3] + "</li><li><b>Latitude:</b> " +det[4] + "</li><li><b>Longitude:</b> " + det[5] + "</li><li><b>City/State:</b> " + det[6] + "</li><li><b>Gender/Marital Status/Lanuguage Spoken:</b> " + det[7] + "</li></ul></font>";
                     }
                   }		
				   
				   //console.log("pmess=========",pmess);
                    	
					  //green=#59c918
				  //orange=#f7be02
				  //red=#c93441
				  //dark green=#45855a

                zi = getZisym(symptom,Number(mainvalue));

				  var mainmess = "<b><font size=4 color='red'>TOTAL RECORDS: " + totrecs + "</font></b><br>" + pmess;
				  //uniquepatients = uniquepatients + totrecs;
                  //console.log("zi===",zi);
				  
			//	  console.log("mainrisk=",mainrisk, " lat=",mainlat, " lon=",mainlon, " riskthreshold=",riskthreshold);
				  
 				  if (mainrisk < riskthreshold){
				   
					heatmap.options= {
						color: zi[1],
						radius: zi[0],
						gradient: true,
						clickable: false
					};	          
				  			  

			        heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);
				
				  tr = (zi[0])*.7;
					heatmap.options= {
						color: zi[2],
						radius: tr,
						gradient: true,
						clickable: false
					};	          
			          heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);
                   }else if(mainrisk >= riskthreshold && mainrisk <= riskthreshold * 1.5){
					heatmap.options= {
						color: zi[1],
						radius: zi[0],
						gradient: true,
						clickable: false
					};	          

			        heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);
				
				  tr = (zi[0])*.7;
					heatmap.options= {
						color: zi[2],
						radius: tr,
						gradient: true,
						clickable: false
					};	          
			          heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);				   				   
				   }else if(mainrisk > riskthreshold * 1.5 ){
					heatmap.options= {
						color: zi[1],
						radius: zi[0],
						gradient: true,
						clickable: false
					};	          

			        heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);
				
				  tr = (zi[0])*.9;
					heatmap.options= {
						color: zi[2],
						radius: tr,
						gradient: true,
						clickable: false
					};	          
			          heatmap.testAddData([{"lat":Number(mainlat),"lon":Number(mainlon)}],1,mainmess);				   				   
				   
				   
				   }
   				
				}   
                //   pmess = "<b>RiskLevel:</b> " + risk + "<ul><li><b>PatientID:</b> " + pid + "</li><li><b>Symptom:</b> " + sns[1] + "</li><li><b>Value:</b> " + val1 + //"</li><li><b>Latitude:</b> " + lat + "</li><li><b>Longitude:</b> " + lon;
     	            
				//	console.log("pmess=",pmess);
					
				  

   		   heatdata = null;						  
		   vlen= null;
          keybuf= null;
		  sns= null;	
		  risk= null;
	 	 buf= null;
		 pid= null;
		 valbufnum= null;
         val1= null;
	     lat= null;
    	 lon= null;		
		 pmess= null;
		 tr=null;
		 latlonmap=null;
 
   }


		function getCookie(cname) {
			let name = cname + "=";
			let decodedCookie = decodeURIComponent(document.cookie);
			let ca = decodedCookie.split(';');
			for(let i = 0; i <ca.length; i++) {
				let c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
		return "";
		}
        
		function saveCheckbox(checkbox, type){
			const d = new Date();
			d.setTime(d.getTime() + (30*24*60*60*1000));
			let expires = "expires="+ d.toUTCString();
            			
		   if (checkbox.checked){
			document.cookie = type + "=true;"  + expires + ";path=/";			 		   
		   }else{
		   document.cookie = type + "=false;"  + expires + ";path=/";	
		   }
		}

        function deleteCookie(name){
           document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
       };

		function savePatientdatanum(filenumber){
			const d = new Date();
			d.setTime(d.getTime() + (30*24*60*60*1000));
			let expires = "expires="+ d.toUTCString();
            			
			document.cookie = "filenumber=" + filenumber + ";"  + expires + ";path=/";			 		   
		}
		
		
		function saveEmails(emails){
//		 if (emails.length>0){
		 
			const d = new Date();
			d.setTime(d.getTime() + (30*24*60*60*1000));
			let expires = "expires="+ d.toUTCString();
		    mainemails = emails; 
			document.cookie = "riskemails" + "=" + emails + ";" + expires + ";path=/";			 
	//		}
			
			let kafkainput = document.getElementById("kafkatopic");
			
			
		// if (kafkainput.value!=""){		 
		   //console.log(kafkainput.value);
		   
			//const d2 = new Date();
			d.setTime(d.getTime() + (30*24*60*60*1000));
			//let expires2 = "expires="+ d.toUTCString();
		    kafkatopictowrite = kafkainput.value; 
			document.cookie = "kafkatopic" + "=" + kafkainput.value + ";" + expires + ";path=/";			 
			//}
			
			
		}
		
		function getSavehours(value,type){	
         // var valueperc=0;
		   
			const d = new Date();
			d.setTime(d.getTime() + (30*24*60*60*1000));
			let expires = "expires="+ d.toUTCString();
						
		  if (type=="hours"){
		    if (value==-1){
		     value = getCookie("riskhours");
			 }
		     let element = document.getElementById("riskhours");
			 if (value){
              element.value = value;
			  }else{
                value=4;
				 element.value = value;
			  }
			 mainriskhourstosave=value;
			 totalriskdatatosave = 12*60*Number(value);
			document.cookie = "riskhours" + "=" + value + ";" + expires + ";path=/";			 
			
           }			 
        
 		if (type=="emails"){
		    if (value==-1){
		     value = getCookie("riskemails");			 
			 }
		     let element = document.getElementById("riskemails");
			 if (value.length>0){
              element.value = value;
			  }else{
                value="";
				 element.value = value;
			  }
			mainemails=value;
			  //console.log(mainemails);

			document.cookie = "riskemails" + "=" + value + ";" + expires + ";path=/";			 
			
           }	
           
		   if (type=="perc"){		  
		   if (value==-1){
		     value = getCookie("riskperc");
			 }
		      let element = document.getElementById("riskperc");
			 if (value){
              element.value = value;
			  }else{
                valueperc=70;
				 element.value = value;
			 }		
			 
            riskthreshold=Number(value);			 
			document.cookie = "riskperc" + "=" + value + ";" + expires + ";path=/";			 
		  }
		  
		  if (type=="backcheck"){
		      value = getCookie("background");		
			  
			  let element = document.getElementById("backcheck");
			  if (value=="false"){
			    element.checked=false;
				dobackground=0;
			  }else{
			      element.checked=true;
				  dobackground=1;
			  }
		  }
		  
		  //patientdatanum
		    if (type=="filenumber"){
			   //deleteCookie("filenumber");
		      patientdatanum = getCookie("filenumber");			
              patientdatanum = Number(patientdatanum);			  
		     }

		    if (type=="kafkatopic"){
			   //deleteCookie("filenumber");
		      kafkatopictowrite = getCookie("kafkatopic");		
              let element = document.getElementById("kafkatopic");
			  element.value=kafkatopictowrite;
			  
		     }
			 
		 }
		 
        ////////////////////////////////////STORE RISK Data
       function isArrayInArray(arr, subarr){
         for(var i = 0; i<arr.length; i++){
         let checker = false
           for(var j = 0; j<arr[i].length; j++){
             if(arr[i][j] === subarr[j]){			    
                checker = true
             } else {
                checker = false				
                break;
             }
          }
           if (checker){
              return true
           }		   
        }
		// console.log("FFFFFFFFFFFFFF=",arr, subarr);
         return false
       }
		 
          function storepatientdata(maindetailsmap,topic){

     	        var currtimestamp = new Date();
             var datestring = currtimestamp.getFullYear() + "-" + ("0"+(currtimestamp.getMonth()+1)).slice(-2) +"-"+("0" + currtimestamp.getDate()).slice(-2) + " " +
				currtimestamp.getHours() + ":" +  ("0"+currtimestamp.getMinutes()).slice(-2);


		    if (patientdatanum>=totalriskdatatosave){
			  patientdatanum=0;
			}
		  //maindetailsmap.set(keybuf,uniqueArray);
		    var r=0;
           var buf ="\"Date,Symptom,Code,Patient,Value,Latitude,Longitude,Risk\",";
			var keybuf;
			var symname;
			var valbuf;
			var valbuf2;
			var mainvalue;
			var lat="n/a";
			var lon="n/a";
			var coord="";
			var found=false;
			var hasrecord=0;
			
			for (const [key, value] of maindetailsmap) {
			  keybuf=`${key}`;
			
			//   console.log("maindetailsmap=",maindetailsmap);
			   //hasrecord=0;
			   symname=getSymptomname(keybuf);
			    
			   // var c = keybuf.split("_");
				for (d in value){					
				//  if (d==0){
				    valbuf = value[d];
					valbuf2 = valbuf.split("(");
					mainvalue = valbuf2[1].split(",")[0];
					
					coord=valbuf2[1].split(",");
					
					//console.log("val=",valbuf2[1].split(","));
					if (previouspatientdatasaved.length ==0){
					    previouspatientdatasaved.push([symname[0],valbuf2[0]]);
					}else{
					   var check=[symname[0],valbuf2[0]];
				       found=isArrayInArray(previouspatientdatasaved,check);
					   if (found==false){
					       previouspatientdatasaved.push([symname[0],valbuf2[0]]);
					   }
					}
					
					if (coord.length >= 3){
					  lat = coord[1];
					  lon = coord[2];
					}
			
		          //     console.log("previouspatientdatasaved=",previouspatientdatasaved);
					//   console.log("check=",check, " found=",found, " hasrecord=",hasrecord);
			
			if (found==false){
				//	valbuf = valbuf.replaceAll(",",":");
				   buf += "\"" + datestring + "," + symname[1] + ",[" + symname[0] + "]," + valbuf2[0] + "," + mainvalue + "," + lat + "," + lon + "," + maingaugepercentage + "\","; 
				   hasrecord=1;
					}
	    		  //}else{
					//  buf +="\"-,-,-,"  + value[d] + ",-\","; 
					//}
					
				}		
			
			}		  
			if (buf.length > 0 ){
			   buf=buf.slice(0, -1);
			}
				
			//console.log(maingaugepercentage,riskthreshold,hasrecord,buf.length);
			
			if ((maingaugepercentage >= riskthreshold) && (buf.length > 0) && (hasrecord==1)){
		//	console.log("---------------Inside");
			mainfoundrisk=1;
               kafkatopictowrite = kafkatopictowrite.replaceAll(" ","");
			//   mainemails = mainemails.replaceAll(" ","");
				//var sendbuffer="{\"hyperprediction\":" + maingaugepercentage + ",\"Topic\":\""+topic +"\",\"Action\":\"Save\",\"Data\":[" + buf + "],\"Filenumber\":" + patientdatanum + ",\"Emails\":\"" + mainemails + "\"}";
//		      var sendbuffer="{\"Hyperprediction\":" + Math.ceil(maingaugepercentage) + ",\"Action\":\"Save\",\"Data\":[" + buf + "],\"Filenumber\":" + patientdatanum + ",\"Emails\":\"" + mainemails + "\",\"Mainriskhours\":" + mainriskhourstosave + ",\"Background\":" + dobackground + ",\"Kafkatopic\":\"" + kafkatopictowrite + "\"}";
			      var sendbuffer="{\"Hyperprediction\":" + Math.ceil(maingaugepercentage) + ",\"Action\":\"Save\",\"Data\":[" + buf + "],\"Maxfilenumber\":"+totalriskdatatosave + ",\"Filenumber\":" + patientdatanum + ",\"Emails\":\"" + mainemails + "\",\"Mainriskhours\":" + mainriskhourstosave + ",\"Background\":" + dobackground + ",\"Kafkatopic\":\"" + kafkatopictowrite + "\"}";
		 
			 var pnum=patientdatanum;
			  patientdatanumcurrent=patientdatanum;
		//    document.getElementById('downloadpatientdataurl').innerHTML = "<a href='/data/" + topic + "_" + mainport  + ".csv'>Download Patient Data</a>";
             
		//	 console.log("Sendbuffer=",sendbuffer);
			 
			 if (ws!=null){
               ws.send(sendbuffer);           
			   patientdatanum = patientdatanum + 1;
			   savePatientdatanum(patientdatanum);
			  }
			}
			if (mainfoundrisk==1 || maingaugepercentage >= riskthreshold ){
		    //document.getElementById('downloadpatientdataurl').innerHTML = "<a href='/data/" + topic + "_" + websocketport  + ".csv'>Download Patient Data</a>";
			document.getElementById('downloadpatientdataurl').innerHTML = "<a href='#' onclick='javascript:promptDownload(patientdata.value,\"patientdata.csv\")'>Download Patient Data</a>";
			
            }
		  mainpatientbuf=buf;
	       r=null;
           buf = null;
		   keybuf=null;
			symname=null;
			valbuf=null;
			valbuf2=null;
			mainvalue=null;  
        }

		
       function storeriskdata(riskdatatosave){
	      
		    if (riskdatanum>=totalriskdatatosave){
			  riskdatanum=0;
			  riskdatatosave = [];
			}
			
			//var header="DateTime,Symptomname,Code,Value,Ubound,Mean,Timewindow1,Timewindow2\n";
             var buf="";			 
 		    var rowvalue=null;				
		    var twindow = null;
			var sp = null;
			var sp2 = null;
			var e;
		   
			for (r in riskdatatosave){
			  
			     rowvalue=riskdatatosave[r];				
			     twindow = rowvalue[5];
				 sp = rowvalue[1][1];
				 sp2 = sp.split("_");
				
			    for (d in rowvalue[2]){					
				    buf += rowvalue[0] +"," + rowvalue[1][0] +","  + sp2[0] + "," + rowvalue[2][d] +"," + rowvalue[3] +"," + rowvalue[4] + "\n"; 
	    			
				}		
				//console.log("riskobj" + riskdatanum + "_" + r);
				
				const riskobj = {
          			  linedata: buf
			        }
				try{	
			       window.localStorage.setItem("riskobj" + riskdatanum + "_" + r,JSON.stringify(riskobj));		
				   
		       }catch(err) {
					//document.getElementById("demo").innerHTML = err.message;
			//		console.log(err.message);
					 e=err.message;
                  }   
			  buf="";

			}			
            riskdatanum +=1;
			riskdatatosave = [];
			
             buf=null;			 
 		     rowvalue=null;				
		     twindow = null;
			 sp = null;
			 sp2 = null;
			 e= null;
			
       }
	   
	    function loadpatientriskdata(){
	      var num=0;
		  var totaldata="";

		  var riskdataarray = new google.visualization.DataTable();

              //buf += currtimestamp + symname[1] + ",[" + symname[0] + "]," + d + "," + maingaugepercentage + "\n"; 
	    			
		   riskdataarray.addColumn('string','DateTime');
		   riskdataarray.addColumn('string','Symptomname');
		   riskdataarray.addColumn('string','Code');
		   riskdataarray.addColumn('number','Patient');
		   riskdataarray.addColumn('number','RiskValue');
		   
		   var inside=0;
		   var s2;
		   var ss;
		   var sbuf;
		   var sbufarr;
		    let rw;
		   
		  for (rd=0;rd < totalriskdatatosave; rd++){
         	   inside=0;
				
		       while(true){
			     //console.log("riskobj" + rd + "_" + num)
				 
		           s2 = window.localStorage.getItem("patientobj" + rd + "_" + num);
					if (s2){
	                  const obj2 = JSON.parse(s2);		
                    //  totaldata += obj2.linedata;			
                       ss=obj2.linedata.split("\n");
					//  console.log("ss=",ss);
					  
					  for (t in ss){ // row
					     sbuf = ss[t];
						if (sbuf.length > 0){
						   sbufarr = sbuf.split(",");
						   if (sbufarr.length>0 && isNaN(sbufarr[3])==false){
						  
						  //console.log("sbufarr=",sbufarr);
						
					    //let rw = [ss[t][0],ss[t][1],ss[t][2],ss[t][3],ss[t][4],ss[t][5],ss[t][6],ss[t][7]];
						    rw = [sbufarr[0], sbufarr[1], sbufarr[2],sbufarr[3],Number(sbufarr[4])];
						
						//  console.log("rw=",rw);
						  
					      riskdataarray.addRows([rw]);
						  inside=1;
						}
                       // riskdataarray.push([ss[t][0],ss[t][1],ss[t][2],ss[t][3],ss[t][4],ss[t][5],ss[t][6],ss[t][7] ]);
					    }
					  }
					  
					}else{
                       break;
					 }					
					  num += 1;
				}
								
		  }
	         //console.log("riskdataarray=",riskdataarray);
		    inside=null;
		    s2=null;
		    ss=null;
		    sbuf=null;
		    sbufarr=null;
		    rw=null;
			 
			 return riskdataarray;
	   }

	           ////////////////////////////////////LOAD RISK Data
       function loadriskdata(){
	      var num=0;
		  var totaldata="";

		  var riskdataarray = new google.visualization.DataTable();

		//   riskdataarray.addColumn('string','DateTime');
		   riskdataarray.addColumn('string','Symptomname');
		   riskdataarray.addColumn('string','Code');
		   riskdataarray.addColumn('number','Value');
		   riskdataarray.addColumn('number','Ubound');
		   riskdataarray.addColumn('number','Mean');
		 //  riskdataarray.addColumn('string','Timewindow1');
		  // riskdataarray.addColumn('string','Timewindow2');

       		var inside=0;
			var s2;
			var ss;
			var sbuf;
			var sbufarr;
			var rw;
		   
		  for (rd=0;rd < totalriskdatatosave; rd++){
         	   inside=0;
				
		       while(true){
			     //console.log("riskobj" + rd + "_" + num)
				 
		        	 s2 = window.localStorage.getItem("riskobj" + rd + "_" + num);
					if (s2){
	                  const obj2 = JSON.parse(s2);		
                    //  totaldata += obj2.linedata;			
                       ss=obj2.linedata.split("\n");
					//  console.log("ss=",ss);
					  
					  for (t in ss){ // row
					     sbuf = ss[t];
						if (sbuf.length > 0){
						   sbufarr = sbuf.split(",");
						   if (sbufarr.length>0 && isNaN(sbufarr[3])==false){
						  
						  //console.log("sbufarr=",sbufarr);
						
					    //let rw = [ss[t][0],ss[t][1],ss[t][2],ss[t][3],ss[t][4],ss[t][5],ss[t][6],ss[t][7]];
						    rw = [sbufarr[1], "["+sbufarr[2]+"]",Number(sbufarr[3]),Number(sbufarr[4]),Number(sbufarr[5])];
						
						//  console.log("rw=",rw);
						  
					      riskdataarray.addRows([rw]);
						  inside=1;
						}
                       // riskdataarray.push([ss[t][0],ss[t][1],ss[t][2],ss[t][3],ss[t][4],ss[t][5],ss[t][6],ss[t][7] ]);
					    }
					  }
					  
					}else{
                       break;
					 }					
					  num += 1;
				}
				
			//	if (inside==0){
				//  break
				//}
				
		  }
	         //console.log("riskdataarray=",riskdataarray);
       		 inside=null;
			 s2=null;
			 ss=null;
			 sbuf=null;
			 sbufarr=null;
			 rw=null;
             num=null;
		    totaldata=null;
		  
			 return riskdataarray;
	   }

	   
       function storehealthrisk(){
	   //console.log("healthriskarray=",healthriskarray);
	     try{
	        var currtimestamp = new Date();
	        if (healthriskarray.length<=totalriskdata){
			  healthriskarray.push([currtimestamp,maingaugepercentage]);			  
			}else{
			   healthriskarray.shift();
			     healthriskarray.push([currtimestamp,maingaugepercentage]);	
			}
						
		 }catch(err){
		     console.log(err.message);
             var e=err.message;
           }		 
	   }
       
	   
	   function loadhealthrisk(){
			var s = window.localStorage.getItem('riskobj');
			const obj = JSON.parse(s);
           maintimestamp = new Date(obj.date);
		   maingaugepercentageavg = Number(obj.riskvalue);
		     maingaugepercentage = Number(obj.riskvalue);
		   //storehealthrisk();
		    healthriskarray.push([maintimestamp,maingaugepercentage]);	
			
			var s2 = window.localStorage.getItem('riskobjtosave');
	       const obj2 = JSON.parse(s2);		
           riskdatanum = Number(obj2.totalnum);
          
       }	   
	   
       function monitoringpopup(){
          new Attention.Prompt({
                    title: "Population Symptoms Currently Being Monitored",
                    content: mainmonitoring,
                });
         
	   }
    
	   function deleteKeysfromidentifiermap(){
	         var keydel = [];
			 
             //delete keys from identifiermap
	//		 console.log("foundissues=",foundissues);
			 
            for (const [key, value] of identifiermap) {
			 keybuf=`${key}`;
			 valbuf=`${value}`;
			 var found=0;
             for (fi in foundissues){
                  var ki = foundissues[fi][0];
				  if (ki==keybuf ){
				    found=1;
					break;
				  }
               }			
                if (found==0){
                      keydel.push(keybuf);
				 }				
            }
			for (d in keydel){		
              if (keydel[d].includes("_ubound")==false){
			   identifiermap.delete(keydel[d]);
			  }
			}
	   }
 	   
	   function computeintensitycurve(jsondata){
	         
			 var symptomdata = [];
			 var ubounddata = [];
			 var symptomname = [];
			 var timewindow = [];
		//	 var identifier = [];
			 var riskdatatosave = [];
			 var keybuf;
			  var varr;
			  var keydata;
			   var keydatatime;
			   var  keyidentbuf;
			 var jbuf;
			 var js;
			 var buf;
			 var jvalue;
			 var winstart;
			 var winend;
			 symptommap=null;
			 identifiermap=null;
			 
			 symptommap = new Map();
             identifiermap = new Map();
            // superidentifiermap = new Map();
			 
 
			// oldData =  google.visualization.arrayToDataTable(['Symptom', 'Count of Symptom']);
			 //newData = google.visualization.arrayToDataTable(['Symptom', 'Count of Symptom']);
			
		//	console.log("idkeyarr=",idkeyarr);
			//console.log("jsondata.TopicReads=",jsondata.TopicReads);
			 
    		    for (k in idkeyarr){
	    		   keybuf = idkeyarr[k];
				     varr = keybuf.split(" ");							  
			         keydata = [];
					  keydatatime = [];
				//	 var keyident = [];
					  keyidentbuf = "";
					//var keyub = [];
		    	 	for (j in jsondata.TopicReads){
			           jbuf=jsondata.TopicReads[j].Topic;
				       js=jbuf.split("_");
				       buf = jbuf.substring(js[0].length+1);
				
						//	if (varr[0]==symptomcode){
					//	console.log("buf=" + buf + ", varr[0]=" + varr[0]);
					     if (buf==varr[0] ){
                             jvalue=Number(jsondata.TopicReads[j].hyperprediction);						  
 				             keydata.push(jvalue); 
							 
							// console.log("INSIDE subtopic=",buf, " jvalue=",jvalue);
							 
					//		 symptommap.set(varr[0],jvalue);
							 
            				 winstart=jsondata.TopicReads[j].WindowStartTime;
			             	 winend=jsondata.TopicReads[j].WindowEndTime;
							keydatatime.push([winstart,winend]);
					//		keyident.push(jsondata.TopicReads[j].Identifier);
					        keyidentbuf = jsondata.TopicReads[j].Identifier + ";";
							 
				         }
					}
					  
					 
					if (keydata.length>0){
					   //keydata.push(varr[0]);//name
					   //keydata.push(varr[1]); //ubound
					   //keydata.push(varr[2]); //mean
					    symptomname.push([varr[3],varr[0]]);
                       	symptomdata.push(keydata);		
                        ubounddata.push([varr[1], varr[2]]);	
                        timewindow.push(keydatatime);	
                     //    identifier.push(keyident);						
						 symptommap.set(varr[0]+"_total",keydata.length); // store the total count of each symptom		
						// console.log("keyident=",keyidentbuf);
                         identifiermap.set(varr[0],keyidentbuf); // store the total count of each symptom			
                         identifiermap.set(varr[0]+"_ubound",varr[1]); // store the total count of each symptom			
						
					//	console.log("--------ubound=",varr[1], " keybuf=",varr[0]+"_ubound");
						 
					}else{
						 symptommap.set(varr[0]+"_total",0); // store the total count of each symptom
					
					}
					

					if (varr[0]!="n/a"){
					  symptommap.set(varr[0],0);
					}

//			   console.log("symptomdata=",symptomdata, "k=", k, " keyidentbuf=",keyidentbuf, " subtopic=",varr[0]);
					
				 }
               
				//	 console.log("symptommap=",symptommap);
                  //    console.log("symptomdata=",symptomdata);
			   
             /////////////////////////////////Compute the delta data for curve
			// console.log("Indentifier map 1618 row=", identifiermap);
			 
			if (symptomdata.length>0){
			  var icdata = [];
			      var uarr = null;
				  var ubound= null;
				  var mean= null;
				  var dataarr = null;
				  var rdata = null;
				   var val;
				   var sname;
				   var mapcnt;
			       foundissues = [];
		      for (let sd = 0; sd < symptomdata.length; sd++) {
			       uarr = ubounddata[sd];
				   ubound=uarr[0];
				   mean=uarr[1];
				   dataarr = symptomdata[sd]; // get the data for each symptom
				   rdata = [];
				  sname=symptomname[sd]; // ['name', 'code_preprocess_Avg']
				
			//	console.log("sname=",sname[1]," ubound=",ubound, " dataarr=", dataarr)

				   var issuefound=0;
				  
			      for (i in dataarr){				     					
				     if (dataarr[i]>ubound){
					     val = Math.abs(dataarr[i]-mean);
					    rdata.push(val);  // delta
			//		    console.log("symptom name above upper bound=",sname[0], " sd=",sd, " dataarr[i] ",dataarr[i], " ubound=",ubound );	

						 mapcnt=symptommap.get(sname[1]);
					    symptommap.set(sname[1],mapcnt+1);
					    issuefound=1; 
					 }else{
					   rdata.push(0);
					 }
				  }
				  if (issuefound){
				     foundissues.push([sname[1],sname[0]]);
				  }
				//  console.log("Found issues=",foundissues);
				  
				  if (rdata.length>0){
				    icdata.push(rdata);
				  }
				  riskdatatosave.push([new Date().toISOString().slice(0, 19),symptomname[sd],dataarr, ubound,mean,timewindow[sd]]);
			   }
            			
		//	console.log("icdata=",icdata);
			//console.log("icdtalen=",icdata.length);
			
		   /////////////////////////////////////////////Get the curve data	
		   var inum=0;
		   icvals = [];
		   var icnum=0;
		   var totalic=0;
			var ival = 0;
			var inside=0;
			var undef=0;
			var sd=0;
		   var m;
		   
		//   console.log("icdata----------",icdata);
		   
		    while(true){				
			    ival = 0;
				inside=0;
				undef=0;
				sd=0;
				
		        for ( sd = 0; sd < icdata.length; sd++) {
				      m=icdata[sd];
					// console.log("m=",m,m[inum],inum);
					 
					 if (typeof(m[inum])!== "undefined"){  // go through each symptom
				        ival = ival + m[inum];
						inside=1;						
						//console.log("inside loop=",inside);
						//symptommap.set();
						
                    }else{
                       undef +=1;
					}			
                    					
				}
				var halfsd= Math.ceil(sd*.3);
			    document.getElementById('totsymptoms').innerHTML=symptomcount;			 			
			   
			   if (ival>0 && ((sd-undef)>halfsd)){
			     icnum += 1;
			   }
   		  //     console.log("(sd-undef)=",(sd-undef),"Sd=",sd," undef=",undef,"halfsd=",halfsd, "ival=",ival, " icnum=",icnum);

			   icvals.push(ival); // main curve data
			   
			   inum+=1;
			  
			   
			   if (inside==0){
			      break;
			    }
			 }
		     // Health risk percentage
		//	 	console.log("icvals=",icvals)
			//  	console.log("icnum=",icnum)
			//	console.log("icnum=",icnum, " inum=",inum);
					
			 maingaugepercentage = (icnum/inum)*100;
			 maingaugepercentage = maingaugepercentage.toFixed(1);
         		//console.log("maingaugepercentage=",maingaugepercentage);
			
		     storeriskdata(riskdatatosave);
			 
			  symptomdata = null;
			  ubounddata = null;
			  symptomname = null;
			  timewindow = null;
			  riskdatatosave = null;
			  keybuf=null;
			  varr=null;
			  keydata=null;
			  keydatatime=null;
			   keyidentbuf=null;
			  jbuf=null;
			  js=null;
			  buf=null;
			  jvalue=null;
			  winstart=null;
			  winend=null;
			  icdata = null;
			  uarr = null;
			 ubound= null;
			 mean= null;
			 dataarr = null;
			 rdata = null;
			 val=null;
			 sname=null;
			 mapcnt=null;

		    inum=null;
		   
		   icnum=null;
		   totalic=null;
		 ival =null;
		 inside=null;
		 undef=null;
		 sd=null;
		 m=null;
			 
		   }
		   
		}
			 
	   
	   
	   function getAlltopics(jsondata){
	        
			var topics = [];
			var js;
			var buf;
			
			for (j in jsondata.TopicReads){
				   jbuf=jsondata.TopicReads[j].Topic;
				   let js=jbuf.split("_");
				   let buf = jbuf.substring(js[0].length+1);
				  topics.push(buf); 
			}
	       uniqueArray = Array.from(new Set(topics)); 
		   //console.log("uniq=",uniqueArray);
		   topics=null;
		   js=null;
		   buf=null;
		   
		   return uniqueArray;
	   }
	   
	   function saveDynamicDataToFile(topic) {

     //       var userInput = document.getElementById("txtData").value;	
            const textToBLOB = new Blob([userInput], { type: "text/plain;charset=utf-8" });
           const sFileName = topic+"-fhir-JSON.json";	   // The file to save the data.

           let newLink = document.createElement("a");
           newLink.download = sFileName;

           if (window.webkitURL != null) {
              newLink.href = window.webkitURL.createObjectURL(textToBLOB);
           }
           else {
            newLink.href = window.URL.createObjectURL(textToBLOB);
            newLink.style.display = "none";
            document.body.appendChild(newLink);
           }

        newLink.click(); 
		
        }
		
		function highlightRow(index,symptom,symptomcode,processtype){
				    
			  if (datatbl){
						
                 datatbl.setProperties(index, 5, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
				   datatbl.setProperties(index, 4, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
		          datatbl.setProperties(index, 3, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
		          datatbl.setProperties(index, 1, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
		          datatbl.setProperties(index, 2, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
		          datatbl.setProperties(index, 6, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
		          datatbl.setProperties(index, 7, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
				     datatbl.setProperties(index, 8, {style: 'background-color:red;font-size:16px;color:#ffffff;'});
                  datatbl.setProperties(index, 9, {style: 'background-color:red;font-size:16px;color:#ffffff;'});		
                  if (issues.includes(symptomcode)==false){				  
                     issues += "[" + symptom + " ("+symptomcode +", " + processtype +")]; ";
				  }
				//  document.getElementById('issues').innerHTML  = "<font color=red size=3><b>" + issues + "</b></font>";
				  issuecount +=1;
              
		      }
		}
		
		function gettabledata(data){
		  if (!datatbl){
		    return;
		  }
		    let thedate="";
			let latestdate="";
			if (data){
		    data.addColumn('date', "Date");
			 data.addColumn('number', "Value");
			 
			 data.addColumn({type: 'string', role: 'annotation', p: {html: true}});
             data.addColumn({type: 'string', role: 'annotationText', p: {html: true}});
			  }
			  
		   datatbl.sort({column: 1, desc: true});
		   
		   var scode;		   
		   var selectedData;
		   var depvar;
		   var ubound;
		   var mean;

		   var time1;
		   var time2;
		   var totmess;
		   var ptype;

		   var kafkakey;
		   var offset;
		   var partition;
		   
		  for (t = 0; t < predictioncount; t++) {
		   thedate = datatbl.getValue(t, 1);
		   		   
		   if (t==0){
		     latestdate=thedate;
		   }
		   dvalue=new Date(thedate);
		 //  console.log("The date=",dvalue);
		   
		    scode = datatbl.getValue(t, 4);		   
		    selectedData = datatbl.getValue(t, 6);
		    depvar=datatbl.getValue(t, 3);
		    ubound=datatbl.getValue(t, 8);
		    mean=datatbl.getValue(t, 7);

		    time1=datatbl.getValue(t, 1);
		    time2=datatbl.getValue(t, 2);
		    totmess=datatbl.getValue(t, 9);
		    ptype=datatbl.getValue(t, 5);

		    kafkakey=datatbl.getValue(t, 10);
		    offset=datatbl.getValue(t, 11);
		    partition=datatbl.getValue(t, 12);

		   
		   let deptext="<b><font size=3>The Current Population Value For Symptom</font><font color='red' size=3><i>"+depvar + "</i></font>" + "<font size=2> ("+ scode + ", " + ptype + ")</font> <font size=3> Is </font> <font color='red' size=3><u>" + selectedData+"</u></font></b>.";
           if (mean==-1){
		   deptext += "<br><font size=3><b>The mean value for this symptom is not defined.</b></font><br>";
		   }else{
		   deptext += "<br><font size=3><b>The mean value for this symptom is :" + mean + "</b></font><br>";		  
		   }
		   
		   if (selectedData > ubound && ubound!=-1){
		       
			   highlightRow(t,depvar,scode,ptype);
		   
		       let diff = Math.abs(ubound - selectedData);
			   diff = diff.toFixed(3);
		       deptext += "<b><font color='red' size=3>This Current Population Value is ABOVE the upper bound of " + ubound + " by " + diff  + " points</font></b><br>";
		   }else if (ubound==-1){
		        deptext += "<b><font size=3>Upper bound not defined</font></b><br>";
		   }
		   else{
		       deptext += "<b><font size=3>This Current Population Value seems NORMAL.</font></b><br>";		   
		   }
		       deptext += "<ul><li><font size=3>The Time Window for this current value is between: " + time1 + " and " + time2 +"</font></li>";		   
		       deptext += "<li><font size=3>Total messages in this time window are: " + totmess + "</font></li>";		   
		       deptext += "<li><font size=3>Process Type is: "  + ptype + "</font></li>";		   
		       deptext += "<li><font size=3>Kafka Key: "  + kafkakey + "</font></li>";		   
		       deptext += "<li><font size=3>Offset: "  + offset + "</font></li>";		   
		       deptext += "<li><font size=3>Partition: "  + partition + "</font></li></ul>";		   
		   
		//   let indeptext="";
		  		   
		//	 data.addRow([ 	dvalue, selectedData,deptext,""]);
			 //console.log(dvalue, selectedData,deptext,indeptext);
		  }
		    //thedate=null;
		//	latestdate=null;
		    diff=null;
		  	 scode = null;		   
		    selectedData = null;
		    depvar=null;
		    ubound=null;
		    mean=null;

		    time1=null;
		    time2=null;
		    totmess=null;
		    ptype=null;

		    kafkakey=null;
		   offset=null;
		    partition=null;

		   
		    deptext=null;
		   
		  return [thedate,latestdate,data];
		}



         function getUniquepatientswithissues(){
            var up =[];
			const word="Msgsjoined=";
			let rcnt=0;
			
    		  for (kv in idkeyarr){
		        let buf=idkeyarr[kv];
			    let buf2=buf.split(" ");
			    let buf3 = buf2[0].split("_");
			  
			//  console.log("buf2[0]=",buf2[0]);
			  
			    var found = identifiermap.get(buf2[0]);
				if(found){
               index = found.indexOf(word);   // 8
               length = word.length;			// 7

               result = found.slice(index + length);
			   resultarr = result.split(";");
   				//console.log("found==",found);
               rcnt = rcnt + 1;

				
				for (ui in resultarr){				
				   let upbuf = resultarr[ui].split("(")[0];
				   let upbuf2 = resultarr[ui].split("(")[1];
				   if (upbuf2){
				   let val = upbuf2.split(",");
				 //  console.log("-----val=",val[0], "---buf2=",buf2[1]);
				   
				   if(upbuf!="n/a" && Number(val[0])>=Number(buf2[1]) ){
			         up.push(upbuf);	
                  }				
                 }				  
				}			  
			  }
			 } 
			  
		       let uniqueArray = Array.from(new Set(up)); 
               
			 //  console.log("up lenght=",uniqueArray.length);
			  return  [uniqueArray.length, rcnt];
	     }


		 
		function drawDiffChart(identifiermap,topic,symptomtotal, patientrecs){
		//testchart();
		//return;
		var oldData=null;
		var newData=null;
		
	     if (identifiermap==null){
		  oldData = google.visualization.arrayToDataTable([
			['Symptom', 'Count of Symptom'],
			['TBD', 0],
			]);

			newData = google.visualization.arrayToDataTable([
			['Symptom', 'Count of Symptom'],
			['TBD', 0],
			]);
		
		 mainmonitoring="";
		 
		 if (idkeyarr){
		 
		 
		   var keybuf;
		   var varr;
		   for (k in idkeyarr){
	     	  keybuf = idkeyarr[k];
			  varr = keybuf.split(" ");		
             if (varr[0]!="n/a"){			  
			  mainmonitoring += "[" + varr[3] + "(" + varr[1] + ", " + varr[2] + ", " + varr[0] + ")] ";
			  }
		   }
		 }  
	    }else{			
		

		    oldData = new google.visualization.DataTable();
		    newData = new google.visualization.DataTable();
		    
			
			oldData.addColumn('string','Symptom');
		    oldData.addColumn('number','Count of Symptom');
            //oldData.addColumn({type:'string',role:'tooltip'});
			
		    newData.addColumn('string','Symptom');
		    newData.addColumn('number','Count of Symptom');
            //newData.addColumn({type:'string',role:'tooltip'});
			
			var keybuf;
			var valbuf;
			var ka;
			
			
			//console.log("identifiermap map=",identifiermap);
			//console.log("symptomtotal =",symptomtotal);
			
			
            for (const [key, value] of identifiermap) {

			  keybuf=`${key}`;
			 
		//	 console.log("main=",symptomtotal.get(key));
			 
			// console.log("valbuf=",valbuf);
                ka = keybuf.split("_");  	
			// console.log("keybuf=",keybuf, " length=",value.length, " total=",symptomtotal.get(key), " keybuf=",keybuf);
             
//			 console.log("ka=",ka);
               //	console.log("valbuf=",valbuf);
			  // console.log(ka[0],Number(valbuf));
			   
				if (ka[0]!="n/a"){
                  newData.addRows([[ka[0],value.length]]);					  
                  oldData.addRows([[ka[0],symptomtotal.get(key)]]);				  
			     }
			
            }
	   
		 //  console.log("olddata=",oldData);
		  // console.log("newdata=",newData);
		   if(barChartDiff==null){
			barChartDiff = new google.visualization.BarChart(document.getElementById('barchart_div'));
            }else{
			   barChartDiff.clearChart();
			}
			
			var diffData = barChartDiff.computeDiff(oldData, newData);						
 
			var options = {height:330, hAxis: {title: 'Count of Symptom Records'},fontSize:18,chartArea:{height:'350'},legend: { position: 'top' } };

			barChartDiff.draw(diffData, options);

		  // document.getElementById('barchartlabel_div').innerHTML="Population Symptoms Currently Being Monitored: <img src='./help.png' width=30 height=27  style='float: bottom;' //onclick='monitoringpopup()'>";	
          var diffbuf="<b>Total Symptoms Being Monitored: </b><ul>";
		  symptomcount=0;
		  var buf;
		  var buf2;
		  var buf3;
		  var diffcnt="";
		  var rcnt=0;
		  var foundissuestot=0;
		  var issueareas="";
		  var foundtotalmain=0;
		  
		  //console.log("identifiermap=",identifiermap);
		   let ret=getUniquepatientswithissues();


		  for (kv in idkeyarr){
		      buf=idkeyarr[kv];
			  buf2=buf.split(" ");
			  buf3 = buf2[0].split("_");
			  
			//  console.log("buf2[0]=",buf2[0]);
			  
			  var found = identifiermap.get(buf2[0]);
			  var foundtot = symptomtotal.get(buf2[0]);

			  //console.log("found=",found);
			  //console.log("symptomtotal=",symptomtotal);
			  
			  
			 if (buf3[0]!="n/a"){
			  if(found){
			     foundtotalmain = foundtotalmain + foundtot;
			      diffcnt += "<li><b>" + buf3[0] + "</b>: " + buf2[3] + " </li>";
				  rcnt += 1;
				  foundissuestot = foundissuestot + found.length;
				  issueareas = issueareas + buf2[3]  + " ,";
				}else{
				  diffcnt += "<li>" + buf3[0] + ": " + buf2[3] + " (na/na)</li>";
				
				}
				
				symptomcount +=1;
			 }
		  }
		  
		    let numb=Number(idkeyarr.length)-1;
		  diffbuf="<b>Total Symptoms Being Monitored: <font size=4 color='red'>" + numb + "</font> " + " For <font color='red'>" + patientrecs + "</font> Unique Patients </b>" + "<ul>";
          document.getElementById('barchartlabel_div').innerHTML=diffbuf + diffcnt + "</ul>";             
          document.getElementById('totsymptoms').innerHTML=rcnt;             
    
	      document.getElementById('totissues').innerHTML=ret[0];			 
          if (patientrecs!=0){
	  		  let riskcurr=(ret[0]/patientrecs)*100;
			
          	      document.getElementById('currentrisk').innerHTML="<font size=3><b>Current Health Risk: There are <font size=3 color='red'>" + ret[0] + " out of " + patientrecs + " patients who have exceeded the normal bounds in <i>" +  ret[1] + " out of " + numb + " symptoms:</i></font> " + issueareas.slice(0, -1) + "</b></font>";			 
   
               g2.refresh(riskcurr.toFixed(1));
          }
		  
		  maintotalmessages = maintotalmessages + foundtotalmain;
	      document.getElementById('totrecs').innerHTML=maintotalmessages;			

          document.getElementById('issues').innerHTML="<font color='red' size=3> "+issueareas.slice(0, -1) + "</font>";
		  
		  //issueareas.slice(0, -1)
          
		  issueareas=null;
		  foundissuestot=null;
		  rcnt = null;
           diffcnt=null;
           diffData=null;
		   diffbuf=null;
		   buf=null;
		   buf2=null;
		   buf3=null;
		   options=null;
		   oldData=null;
		   newData=null;
		 }  
		}

	   function parseIdentifier(){
	   
		//	console.log("identifiermap=",identifiermap);
		 //  superidentifiermap.clear();
		var superidentifiermap = new Map();
		
		   var mainpatients = [];
		   var maindetailsmap = new Map();		
           var symptomtotal = new Map();
		   
			 var keybuf;
			 var valbuf;
			 var ubound;
             var index;
              var length;
              var result;
              var bufvalue;		
              var valbufnum;	
               var barray;
              var uniqueArray;			   
			 const word="Msgsjoined=";
			  var resultarr;
			  var patientlist =[];
			  var pidarr;
			  //console.log("identifiermap=",identifiermap);
			  
			for (const [key, value] of identifiermap) {
			  keybuf=`${key}`;
			  valbuf=`${value}`;
			  			  
			 if (keybuf.includes("_ubound")==false ){
			  ubound = identifiermap.get(keybuf + "_ubound");
						  
               index = valbuf.indexOf(word);   // 8
               length = word.length;			// 7

               result = valbuf.slice(index + length);
			   resultarr = result.split(";");
			  
			  mainpatients = [];
			  var totnum=0;
			  
			  for (str in resultarr){
			    bufvalue=resultarr[str];
			   if (bufvalue.includes("(") && bufvalue.includes(")")){
			   
			     pidarr = bufvalue.split("(")[0];
				 patientlist.push(pidarr);
				 //console.log("patient=",pidarr);
				 
			     valbufnum= bufvalue.substring(
                     bufvalue.indexOf("(") + 1, 
                     bufvalue.lastIndexOf(")")                
				   );

				 barray = valbufnum.split(",")[0];
				 totnum += 1;
				
			//	console.log("barray=",barray, " ubound=",ubound);
				
			    if (Number(barray)> Number(ubound) && isNaN(barray)==false && ubound!=-1){
     			  //console.log("----value=",valbufnum, "-----bufvalue=",bufvalue," code=",keybuf, ubound);
				  mainpatients.push(bufvalue);
				 
				 }			 
				
				}
				
			  }			
             
               if (mainpatients.length>0){
			       uniqueArray = Array.from(new Set(mainpatients)); 
				  				  
                       maindetailsmap.set(keybuf,uniqueArray);
					   symptomtotal.set(keybuf,totnum);					   
				}		
          
              }//if		  
			  
		   }
		   
		//   console.log("maindetailsmap=",maindetailsmap);
		 //  console.log("symptomtotal=",symptomtotal);

		   try{
		     addHeatdata(maindetailsmap);
			}catch (e){
                 console.log("Error=",e.message);
            }			
			  uniquepatients = Array.from(new Set(patientlist)); 

       //       console.log("patientlist=", patientlist);
			  
			 drawDiffChart(maindetailsmap,topic,symptomtotal,uniquepatients.length);		
			
			pid=null;
            patientlist=null;			
		    mainpatients = null;
			 keybuf=null;
			 valbuf=null;
			  ubound=null;
              index=null;
              length=null;
              result=null;
              bufvalue=null;		
              valbufnum=null;	
              barray=null;
              uniqueArray=null;			   
		   resultarr=null;

           identifiermap=null;

	      return [maindetailsmap,superidentifiermap];
	   }
	    
		function getSymptomname(sn){
		     var buf;
			 var buf2;
			 var buf3;
		
  		  for (kv in idkeyarr){
		     buf=idkeyarr[kv];
			 buf2=buf.split(" ");
			 buf3 = buf2[0].split("_");
			 			 
			 if (buf2[0]==sn){
			// 			 console.log("Inside, buf2=",buf2[0]," sn=",sn, " buf3=",buf3[0],buf2[3]);

			    //diffbuf += "<li>" + buf3[0] + ": " + buf2[3] + "</li>";
				return [buf3[0],buf2[3]];
			 }
		  }
		  
		  buf=null;
		  buf2=null;
		  buf3=null;
		  
          return ["",""];
		}
		
		function drawHealthRiskPlotly(data){
         
		 if (data==null){
		    return;
		  }
		   var xval =[];
		   var yval = [];
		   for (var i=0;i<data.getNumberOfRows(); i++){
		     xval.push(data.getValue(i,0));
		     yval.push(data.getValue(i,1));		   
		   }

			var trace1 = {
			  type: "scatter",
			  mode: "lines",
			  name: "Health Risk",
			  x: xval,
			  y: yval,
			  line: {color: '#fc0303'}
			}

            //console.log("trace1=",trace1);
			
			var data = [trace1];

			var layout = {
			  title: 'Population Health Risk Intensity Curve',
			  height:350,
			  width: '1300',
			  xaxis: {
				autorange: true,
				range: [xval[0], yval[yval.length-1]],
				rangeselector: {buttons: [
					{
					  count: 1,
					  label: '1h',
					  step: 'hour',
					  stepmode: 'backward'
					},
					{
					  count: 6,
					  label: '6h',
					  step: 'hour',
					  stepmode: 'backward'
					},
					{
					  count: 24,
					  label: '24h',
					  step: 'hour',
					  stepmode: 'backward'
					},
					{step: 'all'}
				  ]},
				rangeslider: {range: [xval[0], yval[yval.length-1]]},
				type: 'date'
			  },
			  yaxis: {
				autorange: false,
				range: [0, 100],
				type: 'linear'
			  }
			};

			Plotly.newPlot('riskchart_div', data, layout);
			

		}
		
		
						
		function drawHealthriskchart(topic){
		      var data = new google.visualization.DataTable();
             	curTime = new Date();
		    data.addColumn('date', "Date");
			 data.addColumn('number', "Value");
			 
			 data.addColumn({type: 'string', role: 'annotation', p: {html: true}});
             data.addColumn({type: 'string', role: 'annotationText', p: {html: true}});
						
			
			var maindetailmap=parseIdentifier(); //updates superidentifiermap
			var superidentifiermap = maindetailmap[1];
			
			storepatientdata(maindetailmap[0],topic);
			
		//	return;
			
			//return
			var hv=null;
			var dvalue=null;
			var selectedData=null;
			var mainriskvalue=null;
			var r=null;		
			var localmap=null;
			var keybuf=null;
			var sns=null;
			var num=null;
			var prevselect=-1;
			
			  for (h in healthriskarray){
			      hv = healthriskarray[h];
				
				//console.log("-----------hv=",hv);
				 
				  dvalue=hv[0];
				  selectedData = hv[1];
				 deptext = "<font size=3><b>Risk Value: " + selectedData + "</b></font>";
				 indeptext = "<br><font size=3>At time: " + dvalue + "</font>";
				   r=0;
				  //main risk value
				   mainriskvalue=Number(selectedData);
				   localmap=superidentifiermap.get(selectedData);
				 
				 
				 //return;
				
				
				if (localmap && (selectedData > riskthreshold) && (prevselect!=selectedData)){				  
				 indeptext += "<br><font size=3><b>Patients: </b></font><br>";
					 
					for (const [key, value] of localmap) {
						 keybuf=`${key}`;
					//	console.log("key=",key, " value= ", value);
						//var valbuf=`${value}`;
						
						   sns=getSymptomname(keybuf);		    
				          indeptext += "<font size=3 color=red><b>" + sns[1] + " (" + sns[0] + ")</b></font><br>";  		
				         //   var varr = value.split(",");
						     num=1;
							 //   console.log("value len=",value.length);
								
                            for (vv in value){ 							
						    indeptext += "<font size=2><b>" + num + ".</b>" + value[vv] + "</font><br>";
							num +=1;
						   }
						
		            }
                   			
				  }
				  
				
				prevselect=selectedData;
				
				//  indeptext="";
			     data.addRow([ 	dvalue, mainriskvalue,deptext,indeptext]);
				 localmap=null;
                 hv=null;
			     dvalue=null;
			     selectedData=null;
			     mainriskvalue=null;
			     r=null;
			     keybuf=null;
			     sns=null;
			     num=null;
							 
			  }
               
			  drawHealthRiskPlotly(data);
						
		    chartrisk=null;
			  maindetailmap=null;
			  data=null;
		     superidentifiermap=null;
		}
	
	function drawJustgage(jsondata,topic){
		   var tcount=0;
		   var data;
		   var tval = 0;
		   var data2;
		   var riskavg=0; 
		   var riskcurr=0;
		   var tnum=0;
		   var t;
		   		   
		   if (healthriskarray.length>0){
		      
		      for (h in healthriskarray){
			     t = healthriskarray[h];
				if (isNaN(t[1])==false){
				tval = tval + Number(t[1]);				
				tnum = tnum + 1;
				}
			  }
			  if (tnum!=0){
		    	  maingaugepercentageavg = Number(tval/tnum);					  
			       maingaugepercentageavg =maingaugepercentageavg.toFixed(1);
			  }else{
			    maingaugepercentageavg=0;
			  }
			  
  			//  console.log("here===",maingaugepercentageavg, " tval=",tval, "healthriskarray.length=",healthriskarray.length, " tnum=", tnum );
              tval=0;
              tnum=0;


		   }else{
		     maingaugepercentageavg=Number(maingaugepercentage);
		   }
		   
		   if (jsondata){
			   tcount = jsondata.TopicReads.length;		
               riskavg=Number(maingaugepercentageavg);
               riskcurr=Number(maingaugepercentage);
			   			   
		   }
		   

		   if (tcount){
             var buf="<font >Found " + issuecount + " Possible Issues</font>";

			 if (issuecount>0){
			    buf="<font color=red>Found " + issuecount + " Possible Issues<br></font><font color=red size=3>In this Time Window: <b><ul><li>" + timestart + "</li><li>" + timeend + "</li></ul></b></font>";
			 }
           
		//    document.getElementById('totrecs').innerHTML=tcount;			 
		 //   document.getElementById('totissues').innerHTML=issuecount;			
		    document.getElementById('tottime').innerHTML="<font size=3><b>Start:</b> " + timestart + "<br><b>End:</b> " + timeend + "</font>"

			}
		   document.getElementById('avgrisk').innerHTML=riskavg + "%";	 
      g1.refresh(riskavg);
	//  g2.refresh(riskcurr);
	  
		    tcount=null;
		    data=null;
		    tval = null;
		    data2=null;
		    riskavg=null; 
		    riskcurr=null;
		    tnum=null;
		    t=null;
	  
	}
		
		function drawChartGauge(jsondata,topic) {
		   var tcount=0;
		   var data;
		   var tval = 0;
		   var data2;
		   var t;
		   
		
		   if (healthriskarray.length>0){
		      for (h in healthriskarray){
			     t = healthriskarray[h];
				tval += Number(t[1]);
			  }
			  maingaugepercentageavg = Number(tval/healthriskarray.length);
			  maingaugepercentageavg =maingaugepercentageavg.toFixed(1);
		   }else{
		     maingaugepercentageavg=Number(maingaugepercentage);
		   }
		   
		   if (jsondata){
			   tcount = jsondata.TopicReads.length;				
                    data = google.visualization.arrayToDataTable([
                     ['Label', 'Value'],
                     ['Avg. Risk', Number(maingaugepercentageavg)]
                    ]);			  			
				
                    data2 = google.visualization.arrayToDataTable([
                     ['Label', 'Value'],
                     ['Curr. Risk', Number(maingaugepercentage)]
                    ]);			  			
			   
		   }else{		   
            data = google.visualization.arrayToDataTable([
             ['Label', 'Value'],
             ['Avg. Risk', 0]
           ]);
            data2 = google.visualization.arrayToDataTable([
             ['Label', 'Value'],
             ['Curr. Risk', 0]
           ]);
		   
          }
           var options = {
             width: 690, height: 230,
             redFrom: 90, redTo: 100,
             yellowFrom:75, yellowTo: 90,
             minorTicks: 5,
			 fontSize: 10,
			 displayZoomButtons: false
           };

           var options2 = {
             width: 430, height: 180,
             redFrom: 90, redTo: 100,
             yellowFrom:75, yellowTo: 90,
             minorTicks: 5,
			 fontSize: 10
           };
		   
			
			if (chartguage==null){
              chartguage = new google.visualization.Gauge(document.getElementById('gaugehealthrisk_div'));
		   }else{
		     chartguage.clearChart();
		   }
           chartguage.draw(data, options);

          	if (chartguagesm==null){
           chartguagesm = new google.visualization.Gauge(document.getElementById('gaugehealthrisksm_div'));
		   }else{
		     chartguagesm.clearChart();
		   }
		   
          chartguagesm.draw(data2, options2);

		   if (tcount){
             var buf="<font >Found " + issuecount + " Possible Issues</font>";

			 if (issuecount>0){
			    buf="<font color=red>Found " + issuecount + " Possible Issues<br></font><font color=red size=3>In this Time Window: <b><ul><li>" + timestart + "</li><li>" + timeend + "</li></ul></b></font>";
			 }
			 
/*			 document.getElementById('gaugehealthrisk2_div').innerHTML="<div class='grid'>" + 
			" <label class='card'> " +
			" <span class='plan-type'>" +
			" Processed: " + tcount + " Messages " + " - " + buf + "</span>" + 
			" </label> " +
			"</div>"
    */	
	}
			
		   tcount=null;
		    data=null;
		    tval = null;
		    data2=null;
		    t=null;
			
        
		}
		
		
		
        function drawChart(jsondata,topic) {
            
		//	curTime = new Date();
     		  issues="";
			  issuecount=0;
			  
			//   document.getElementById('issues').innerHTML  = issues;
            // draw chart on load
			/*  var data = new google.visualization.DataTable();
			
			if (chart==null){
		       data.addColumn('date', "Date");
			    data.addColumn('number', "Value");
			
    			 data.addColumn({type: 'string', role: 'annotation', p: {html: true}});
                 data.addColumn({type: 'string', role: 'annotationText', p: {html: true}});
			     data.addRow([curTime,0,'','']); 
			     chart = new google.visualization.AnnotatedTimeLine(document.getElementById('chart_div'));	
				chart.draw(data, options);
								  
			//console.log("here 1");			
			
			}
				*/
				
         if (jsondata){
		    // Adjust Gauges			
			
		  //ADD previous data
	  	  /* if  (dataintable.length>0 || append==0){
		      if (datatbl){
			      datatbl = new google.visualization.DataTable(); //clear the table
				  var formatter = new google.visualization.NumberFormat({groupingSymbol:'',fractionDigits:0});
					datatbl.addColumn('string', 'Date/Time');
					datatbl.addColumn('string', 'Time Window Start');
					datatbl.addColumn('string', 'Time Window End');
					datatbl.addColumn('string', 'Symptom');
					datatbl.addColumn('string', 'Symptomcode');
					datatbl.addColumn('string', 'Processtype');
					
					datatbl.addColumn('number', 'Current Population Value');				
					datatbl.addColumn('number', 'Normal Mean Value');
					datatbl.addColumn('number', 'Upper Bound Value');
					datatbl.addColumn('number', 'Total Messages');				
					datatbl.addColumn('string', 'Kafkakey');
					datatbl.addColumn('number', 'Offset');
					datatbl.addColumn('number', 'Partition');
					
				  formatter.format(datatbl, 1);	
			  }
			  /////////////////////////UN-COMMENT
           		   
			 for (r in dataintable){
			          console.log("-----------------CALLING Draw table 2");
		            drawTable(dataintable[r][0],dataintable[r][1],dataintable[r][2],dataintable[r][3],dataintable[r][4],dataintable[r][5],dataintable[r][6],dataintable[r][7],dataintable[r][8],dataintable[r][9],dataintable[r][10],dataintable[r][11],dataintable[r][12]   );
			  }
		  }*/
		  
		  //get partition/offset
	//	  var i=0;
		  var text;
		  var val;		 
		//  var partitionarr=[];
        	var createdon;	
			var winstart;
			var winend;
		
			var symptom;
			var processtype;
				
			var identifier;
			var idarr;
			var symptomcode;
			//var topic;
			var processbuf;
			var normalvalue;
			var ubound;
			var predictionvalue;
			var totalmessages;
			var kafkakey;
			var offset;
			var partition;		
		   var arr;
		   var st;
		   var ed;
			var et;
          var vbuf;					   
		   var buf;
		   var vbuf2;
		    var varr;
				/*			
		  do {
             text = "LastOffset_partition_"+i;
			  val=jsondata[text];
			 if (val){
			   partitionarr.push(val);
			 }
			 i++;
            } while(val)
			*/
		  ///////////////////////////////////START mainloop
		 
		  let rownum=0;
		  
		  for (j in jsondata.TopicReads){
          //get the fields 
		     kafkakey=jsondata.TopicReads[j].kafkakey;
			 
		     if (!kafkakeyarr.includes(kafkakey) && kafkakey.length>0){
		        kafkakeyarr.push(kafkakey);
			      
				//  jsonhist=jsonhist+JSON.stringify(jsondata.TopicReads[j]) +",";
				  
			//	i++;	 
				
			//	console.log(jsondata);
				
				 createdon=jsondata.TopicReads[j].TimeStamp;	
				maintimestamp = createdon;
				 winstart=jsondata.TopicReads[j].WindowStartTime;
				timestart=winstart;
				 winend=jsondata.TopicReads[j].WindowEndTime;
				timeend=winend;

				 symptom=jsondata.TopicReads[j].PreprocessIdentifier;
				 processtype=jsondata.TopicReads[j].Preprocesstype;
				
				 identifier=jsondata.TopicReads[j].Identifier;
				 idarr = identifier.split("~");
				 symptomcode = idarr[0];
				 topic = jsondata.TopicReads[j].Topic;
				 processbuf = "_preprocessed_" + processtype;
				 normalvalue=-1;
				 ubound=-1;
				
				for (v in idarr){		
			      vbuf = idarr[v];
		           
				   if (vbuf.includes("identifier:")){				   
				       buf = vbuf.substring(11);
                       idkeyarr = buf.split(",");			
         				for (v2 in idkeyarr){						 
						    vbuf2 = idkeyarr[v2];
						    varr = vbuf2.split(" ");							  
						//	if (varr[0]==symptomcode){
						     if (topic.includes(varr[0]) && topic.includes(processbuf) ){
							   ubound = Number(varr[1]);
							   normalvalue = Number(varr[2]);
							   break;
							}
						
						}
                       					  
				   }
				}
				
				predictionvalue=jsondata.TopicReads[j].hyperprediction;
				totalmessages=jsondata.TopicReads[j].Numberofmessages;
				kafkakey=jsondata.TopicReads[j].kafkakey;
				offset=jsondata.TopicReads[j].Offset;
				 partition=jsondata.TopicReads[j].Partition;		
		
				  predictionvalue = Number(predictionvalue);
				//  datainchart.push(predictionvalue)

				 arr=[createdon,winstart,winend,symptom,symptomcode,processtype,predictionvalue,normalvalue,ubound,totalmessages,kafkakey,offset,partition];
		     	  dataintable.push(arr)
		     
				//data.addRow([ 	rownum, predictionvalue]);
				rownum++;
		
		  /////////////////////   UNCOMMENT 
		     // console.log("-----------------CALLING Draw table 1");
				//drawTable(createdon,winstart,winend,symptom,symptomcode,processtype,predictionvalue,normalvalue,ubound,totalmessages,kafkakey,offset,partition,rownum);
		    
				predictioncount = predictioncount + 1;
            //   document.getElementById('predictionlabel').innerHTML = "<b>"+ predictioncount + "</b>";	
		 		 
              }
	         }	
			      if (rownum>0){

				     drawTable2();
					 gettabledata(null);
                // maintotalmessages = maintotalmessages + rownum;
		        //document.getElementById('totrecs').innerHTML=maintotalmessages;	
					 
					/*  thedates=gettabledata(data);
					  data = thedates[2];
					  
					//  console.log(thedates);
					  
					    st=new Date(thedates[0]);
					    ed=new Date(thedates[1]);
					    et=new Date(ed.getTime() + 1000);
					   
					//    data = google.visualization.arrayToDataTable(icvals);
					  

					  chart.draw(data, {  chartArea:{top:1,width:"2300",height:"100"}, annotationsWidth: 27,  width: '2200',height: '250', displayAnnotations: true,displayAnnotationsFilter: true,fill: 10,thickness: 3,scaleType:'maximized',allowHtml: true,zoomStartTime: st,zoomEndTime: et, displayRangeSelector: true, displayZoomButtons: true})                  					                 
                     */
				  }
		  }
            
		         
		//   i=null;
		   text=null;
		   val=null;		 
		  // partitionarr=null;
		   kafkakey=null;
        	 createdon=null;	
			 winstart=null;
			 winend=null;
		
			 symptom=null;
			 processtype=null;
				
			 identifier=null;
			 idarr=null;
			 symptomcode=null;
			// topic=null;
			 processbuf=null;
			 normalvalue=null;
			 ubound=null;
			 predictionvalue=null;
			 totalmessages=null;
			 rownum=null;
		
			 offset=null;
			 partition=null;		
		    arr=null;
		    st=null;
		    ed=null;
			 et=null;
          vbuf=null;					   
		  buf=null;
		  vbuf2=null;
		  varr=null;
				
				

        }
		
		function drawTable2(){
	//		var cvalue = Number(currentvalue);			 
//			let arr=[createdon,winstart,winend,symptom,symptomcode,processtype,currentvalue,normalvalue,ubound,totalmessages,kafkakey,offset,partition];

            if (maintable==null){
		      maintable = new google.visualization.Table(document.getElementById('table_div'));
			}
			
			var formatter = new google.visualization.NumberFormat({groupingSymbol:'',fractionDigits:0});
			var formatter2 = new google.visualization.NumberFormat({groupingSymbol:'',fractionDigits:3});
			
			
			 if (datatbl==null){
				datatbl = new google.visualization.DataTable();
				
				datatbl.addColumn('string', 'Date/Time');
				datatbl.addColumn('string', 'Time Window Start');
				datatbl.addColumn('string', 'Time Window End');
				datatbl.addColumn('string', 'Symptom');
				datatbl.addColumn('string', 'Symptomcode');
				datatbl.addColumn('string', 'Processtype');
				
				datatbl.addColumn('number', 'Current Population Value');				
				datatbl.addColumn('number', 'Normal Mean Value');
				datatbl.addColumn('number', 'Upper Bound Value');
				datatbl.addColumn('number', 'Total Messages');				
				datatbl.addColumn('string', 'Kafkakey');
				datatbl.addColumn('number', 'Offset');
				datatbl.addColumn('number', 'Partition');
		   
			   datatbl.sort({column: 1, desc: true});
			   maintable.clearChart();
			   
				maintable.draw(datatbl, {showRowNumber: true, width: '100%', height: '100%',page: 'enable',pageSize: 30, allowHtml: true});
				if (append==0){
			   datatbl.removeRows(0, datatbl.getNumberOfRows()-1);
			   }
		     }else{		

			   formatter.format(datatbl, 1);	
			   formatter2.format(datatbl, 2);	
			   datatbl.sort({column: 1, desc: true});
			   if (datatbl.getNumberOfRows()>0 && append==0){
			     datatbl.removeRows(0, datatbl.getNumberOfRows()-1);
			   }
			   
		       datatbl.addRows(dataintable);
			   maintable.clearChart();			 
			  maintable.draw(datatbl, {showRowNumber: true, width: '100%', height: '100%',page: 'enable',pageSize: 30, allowHtml: true, 'cssClassNames': cssClassNames});
  
               
  
			 formatter = null;
			 formatter2 = null;
			  //datatbl=null;
			   
	        }
			
			dataintable = [];
			
			
		 //  document.getElementById('predictionlabel').innerHTML = "<b>"+ predictioncount + "</b>";	
		  /* if (jsonhist.length>0){
		      document.getElementById("txtData").value="["+jsonhist.slice(0,-1) + "]";
		   }*/		   		   					
		
		}
		
		function autoStart(){
           //    e.preventDefault(); // avoid to execute the actual submit of the form.
		         START=1;
//                $("#statustext").val("WEBSOCKET OPEN..Receiving Kafka Msgs...");
				  document.getElementById('statustext').innerHTML="WEBSOCKET OPEN..Receiving Kafka Msgs...";	

		        $("#start").html("Stop Streaming");
		        streamLiveKafkaData();
		 		
		}
		
		//autoStart();
		
		function streamLiveKafkaData(){

          if ("WebSocket" in window) {
            var url = window.location.host;
            console.log(url);
			 mainport=url.split(":")[1];
			//console.log(mainport);
			
		    var urlParams = new URLSearchParams(window.location.search);
			var keys = urlParams.keys();
			var entries = urlParams.entries();
			for(pair of entries) { 			
			    if (pair[0]=="topic"){
				  topic=pair[1];
				 //  document.getElementById('downloadpatientdataurl').innerHTML = "<a href='/data/" + topic + "_" + mainport + ".csv'>Download Patient Data</a>";	
				
             /*if (patientdatanumcurrent){
			      var pnum=patientdatanumcurrent;
		         document.getElementById('downloadpatientdataurl').innerHTML = "<a href='/data/" + topic + "_" + mainport + "_" + pnum + ".csv'>Download Patient Data</a>";
                }else{
                      document.getElementById('downloadpatientdataurl').innerHTML = "Download Patient Data";					
				}*/
				
				}			   
				
				
				if (pair[0]=="topictype"){
				  topictype=pair[1];
				} 
				if (pair[0]=="secure"){
				  secure=pair[1];
				}
				if (pair[0]=="vipertoken"){
				  vipertoken=pair[1];
				}				
				
				if (pair[0]=="consumerid"){
				  consumerid=pair[1];
				}	

               if (pair[0]=="offset"){
				  offset=pair[1];
				}	
				
				if (pair[0]=="rollbackoffset"){
				  rollbackoffset=pair[1];
				}	
				if (pair[0]=="groupid"){
				  groupid=pair[1];
				}	
				if (pair[0]=="append"){
				  append=pair[1];
				}	
			}
			
			
			//url="www.otics.ca:443/smilecdr_external";
           
		  if (window.location.href.indexOf("http://")!=-1){
             ws = new WebSocket("ws://"+url+"/ws");
            }else{
			    ws = new WebSocket("wss://"+url+"/ws");
			}
            ws.onmessage = function(event) {
                curTime = new Date();
				var eventdata=`${event.data}`;
			
				var maindata=eventdata.replace(/\\"/g,'"');
			   maindata=maindata.substr(1, maindata.length-3);

			   //console.log("maindata=",maindata);
			   
				var obj = JSON.parse(maindata);
				 if (obj.ERROR){
//				   $("#statustext").val("Websocket ERROR.."+obj.ERROR);
                document.getElementById('statustext').innerHTML="Websocket ERROR.."+obj.ERROR;		
					   
				   ws.close(1000);
				   alert(obj.ERROR);
				   ws=null;
				    $("#start").attr("disabled", false);
					     $("#start").html("Start Streaming");
						 return
				   }
				   
                if (START==0){
				  if (ws){
					ws.close(1000);
					}
				   ws=null;
				   return;
				}
 		      if (append==0){
				   dataintable.splice(0, dataintable.length)

              //     datainchart.splice(0, datainchart.length)				   
				  predictioncount=0;
				  jsonhist=null;
				    kafkakeyarr.splice(0, kafkakeyarr.length)	
                }
		
            kafkacluster= obj.Webkafkacluster;
			websocketport = obj.Websocketport;
			 document.getElementById('patientdata').value = obj.Filecontent;

		    document.getElementById('accesstime').innerHTML = curTime;
			document.getElementById('kafkacluster').innerHTML = kafkacluster + ", Kafka Topic: " + topic + ", Vipervizport: " + websocketport;
			
			//  console.log("OBJ=",obj);
			   
			   //console.log("-------------START MESSAGE")
			    
			   //console.log("-------------START")
			    //console.log(`${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);
					
				drawChart(obj,topic);

			    //console.log(`drawchart done ${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);
 	             
				 computeintensitycurve(obj);
			    //console.log(`computeintensitycurve done ${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);


					storehealthrisk();
			    //console.log(`storehealthrisk done ${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);


					drawHealthriskchart(topic);       	
			    //console.log(`drawHealthriskchart done ${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);

				drawJustgage(obj,topic);
					

							
			    //console.log(`drawDiffChart done ${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);
					
				obj=null;
				maindata=null;
				eventdata=null;
				superidentifiermap=null;
				
				//console.log(`${performance.memory.usedJSHeapSize / Math.pow(1000, 2)} MB`);

			//	console.log("-------------END")
			   
			//	console.log("---------------NEW MESSAGE SHOULD BE AFTER EVERYTHING DONE--------------------");
            };

            ws.onclose = function(event) {
			  //console.log("event=",event);
			  
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    console.log('[close] Connection died');
					 
                }
				if (ws){
					ws.close(1000);
					}
				ws=null;
			   var el=document.getElementById('loaderdiv');
				   el.style.display = "none";
				
				 $("#start").attr("disabled", false);
//					   $("#statustext").val("Websocket closed");
                  document.getElementById('statustext').innerHTML="WEBSOCKET CLOSED";		
								   
					     $("#start").html("Start Streaming");
            };
            ws.onopen = function(error) {
			   
			    var sendbuffer="{\"Topic\":\""+topic +"\",\"Topictype\":\""+topictype + "\",\"Secure\":"+secure +",\"Vipertoken\":\""+vipertoken+"\",\"Consumerid\":\""+consumerid + "\",\"Offset\":\""+offset + "\",\"RollbackOffset\":\""+rollbackoffset+"\",\"Groupid\":\""+groupid+"\"}";

                 ws.send(sendbuffer);
				 
	 			   var el=document.getElementById('loaderdiv');
				   el.style.display = "block";

				// loadhealthrisk();
               
				
            };
			
            ws.onerror = function(error) {
			  if (ws){
					ws.close(1000);
					}
                console.log(`[error] ${error.message}`);
			//	$("#statustext").val("WEBSOCKET ERROR.."+`[error] ${error.message}`);
             document.getElementById('statustext').innerHTML="WEBSOCKET ERROR.."+`[error] ${error.message}`;		
				
            };
			
			

        } else {

            // The browser doesn't support WebSocket
            console.log("WebSocket NOT supported by your Browser!");
        }
    }


	$('#Export4').click( function(e) {
	
	  riskdataarray=loadpatientriskdata();
	
      if (riskdataarray){        
		//console.log("riskdataarray=",riskdataarray);
		
	     var headerRow = "";
         var number_of_columns = riskdataarray.getNumberOfColumns();
         for (var i=0; i < number_of_columns; i++) {
           headerRow += riskdataarray.getColumnLabel(i).replace("\n", " : ");
           headerRow += (i === number_of_columns - 1) ? "\n" : ",";
        }		
		
        var csvFormattedDataTable = headerRow+google.visualization.dataTableToCsv(riskdataarray);
        var encodedUri = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csvFormattedDataTable);
        this.href = encodedUri;
        this.download = "patientrisk-data.csv";
        this.target = '_blank';
		
	   }else{
	      alert("Start streaming first");
       }	
	   
	} );
	
	$('#Export3').click( function(e) {
	
	  riskdataarray=loadriskdata();
	
      if (riskdataarray){        
		//console.log("riskdataarray=",riskdataarray);
		
	     var headerRow = "";
         var number_of_columns = riskdataarray.getNumberOfColumns();
         for (var i=0; i < number_of_columns; i++) {
           headerRow += riskdataarray.getColumnLabel(i).replace("\n", " : ");
           headerRow += (i === number_of_columns - 1) ? "\n" : ",";
        }		
		
        var csvFormattedDataTable = headerRow+google.visualization.dataTableToCsv(riskdataarray);
        var encodedUri = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csvFormattedDataTable);
        this.href = encodedUri;
        this.download = "healthrisk-data.csv";
        this.target = '_blank';
		
	   }else{
	      alert("Start streaming first");
       }	
	   
	} );
		
	$('#Export2').click( function(e) {
	
	     e.preventDefault(); /*your_code_here;*/ 
		 saveDynamicDataToFile(topic);
		 
		 
		 return false; 
	} );
	
		$('#Export').click(function () {
	  if (topic.length>0){
	     var headerRow = "";
         var number_of_columns = datatbl.getNumberOfColumns();
         for (var i=0; i < number_of_columns; i++) {
           headerRow += datatbl.getColumnLabel(i).replace("\n", " : ");
           headerRow += (i === number_of_columns - 1) ? "\n" : ",";
        }
        var csvFormattedDataTable = headerRow+google.visualization.dataTableToCsv(datatbl);
        var encodedUri = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csvFormattedDataTable);
        this.href = encodedUri;
        this.download = topic + "-fhir-data.csv";
        this.target = '_blank';
	  }else{
	      alert("Start streaming first");
       }	  
    });
	
		$("#idForm").submit(function(e) {
	  if (ws && START==1){
	   ws.close(1000);
	   ws = null;
	   e.preventDefault(); // avoid to execute the actual submit of the form.
	   START=0;
	   $("#start").html("Start Streaming");
	   $("#start").attr("disabled", true);
	    //$("#statustext").val("WEBSOCKET CLOSING...");
      document.getElementById('statustext').innerHTML="WEBSOCKET Closing...";		
	   
	  }else{
        e.preventDefault(); // avoid to execute the actual submit of the form.
		START=1;
        //$("#statustext").val("WEBSOCKET OPEN..Receiving Kafka Msgs...");
         document.getElementById('statustext').innerHTML="WEBSOCKET OPEN..Receiving Kafka Msgs...";

		 $("#start").html("Stop Streaming");
		 streamLiveKafkaData();
		
		}
       
    });
    </script>

</body>

</html>